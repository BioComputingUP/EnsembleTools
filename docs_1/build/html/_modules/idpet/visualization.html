

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>idpet.visualization &mdash; IDPET 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            IDPET
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../demo.html">Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ensemble_analysis.html">ensemble_analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ensemble.html">ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../visualization.html">visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../comparison.html">ensemble_compariosn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">dpet</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IDPET</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">idpet.visualization</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for idpet.visualization</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cProfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">label</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span><span class="p">,</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mdtraj</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idpet.featurization.distances</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idpet.ensemble_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">EnsembleAnalysis</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idpet.featurization.angles</span><span class="w"> </span><span class="kn">import</span> <span class="n">featurize_a_angle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idpet.coord</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idpet.featurization.glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_asphericity</span><span class="p">,</span> <span class="n">compute_prolateness</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idpet.comparison</span><span class="w"> </span><span class="kn">import</span> <span class="n">scores_data</span><span class="p">,</span> <span class="n">process_all_vs_all_output</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">idpet.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">PLOT_DIR</span> <span class="o">=</span> <span class="s2">&quot;plots&quot;</span>

<div class="viewcode-block" id="plot_histogram">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.plot_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_histogram</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">bins</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="nb">range</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Density&quot;</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot an histogram for different features.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax: plt.Axes</span>
<span class="sd">        Matplotlib axis object where the histograms will be for plotted.</span>
<span class="sd">    data: List[np.array]</span>
<span class="sd">        List of NumPy array storing the data to be plotted.</span>
<span class="sd">    labels: List[str]</span>
<span class="sd">        List of strings with the labels of the arrays.</span>
<span class="sd">    bins:</span>
<span class="sd">        Number of bins.</span>
<span class="sd">    range: Tuple, optional</span>
<span class="sd">        A tuple with a min and max value for the histogram. Default is None,</span>
<span class="sd">        which corresponds to using the min a max value across all data.</span>
<span class="sd">    title: str, optional</span>
<span class="sd">        Title of the axis object.</span>
<span class="sd">    xlabel: str, optional</span>
<span class="sd">        Label of the horizontal axis.</span>
<span class="sd">    ylabel: str, optional</span>
<span class="sd">        Label of the vertical axis.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plt.Axes</span>
<span class="sd">        Axis objects for the histogram plot of original labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">_bins</span> <span class="o">=</span> <span class="n">_get_hist_bins</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">)</span>
    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">data_i</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Add mean and/or median lines</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_i</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">location</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
            <span class="n">median_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data_i</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="c1"># Merge histogram and stat lines into legend</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">legend_handles</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_hist_bins</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">range</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>  <span class="c1"># Make a range.</span>
        <span class="k">if</span> <span class="nb">range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
            <span class="n">_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_min</span> <span class="o">=</span> <span class="nb">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_max</span> <span class="o">=</span> <span class="nb">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">_min</span><span class="p">,</span> <span class="n">_max</span><span class="p">,</span> <span class="n">bins</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># The bins are already provided as a range.</span>
        <span class="n">_bins</span> <span class="o">=</span> <span class="n">bins</span>
    <span class="k">return</span> <span class="n">_bins</span>

<div class="viewcode-block" id="plot_violins">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.plot_violins">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_violins</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">summary_stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Histogram&quot;</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
        <span class="n">x_ticks_rotation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">45</span>
      

    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a violin plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax: plt.Axes</span>
<span class="sd">        Matplotlib axis object where the histograms will be for plotted.</span>
<span class="sd">    data: List[np.array]</span>
<span class="sd">        List of NumPy array storing the data to be plotted.</span>
<span class="sd">    labels: List[str]</span>
<span class="sd">        List of strings with the labels of the arrays.</span>
<span class="sd">    summary_stat: str, optional</span>
<span class="sd">        Select between &quot;median&quot; or &quot;mean&quot; to show in violin plot. Default value is &quot;mean&quot;</span>
<span class="sd">    title: str, optional</span>
<span class="sd">        Title of the axis object.</span>
<span class="sd">    xlabel: str, optional</span>
<span class="sd">        Label of the horizontal axis.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plt.Axes</span>
<span class="sd">        Axis objects for the histogram plot of original labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>

    <span class="c1"># Define the list of colors you want to provide</span>
    <span class="n">mycolors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">]</span>  <span class="c1"># You can customize this list</span>

    <span class="c1"># Plot the violin plots and customize the colors for medians and means</span>
    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showmedians</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;cmeans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">mycolors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Set the mean color</span>
        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">mycolors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">mean_line</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">showmeans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showmedians</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;cmedians&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">mycolors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Set the median color</span>
        <span class="n">median_line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">mycolors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">median_line</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showmedians</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;cmeans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">mycolors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    <span class="c1"># Set the mean color</span>
        <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;cmedians&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">mycolors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Set the median color</span>
        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">mycolors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
        <span class="n">median_line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">mycolors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">mean_line</span><span class="p">,</span> <span class="n">median_line</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

    
    <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;bodies&#39;</span><span class="p">]:</span>
        <span class="n">pc</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">pc</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>  <span class="c1"># Set edge color to black for better visibility</span>
        <span class="n">pc</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># Set transparency level</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">x_ticks_rotation</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="plot_comparison_matrix">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.plot_comparison_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_comparison_matrix</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
        <span class="n">comparison_out</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">codes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">significance_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis_r&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;New Comparison&quot;</span><span class="p">,</span>
        <span class="n">cbar_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;score&quot;</span><span class="p">,</span>
        <span class="n">textcolors</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a matrix with all-vs-all comparison scores of M ensembles as a heatmap.</span>
<span class="sd">    If plotting the results of a regular all-vs-all analysis (no bootstraping</span>
<span class="sd">    involved), it will just plot the M x M comparison scores, with empty values</span>
<span class="sd">    on the diagonal. If plotting the results of an all-vs-all analysis with</span>
<span class="sd">    bootstrapping it will plot the M x M confidence intervals for the scores.</span>
<span class="sd">    The intervals are obtained by using the &#39;percentile&#39; method. Additionally,</span>
<span class="sd">    it will plot an asterisk for those non-diagonal entries in for which the</span>
<span class="sd">    inter-ensemble scores are significantly higher than the intra-ensemble</span>
<span class="sd">    scores according to a Mannâ€“Whitney U test.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax: plt.Axes</span>
<span class="sd">        Axes object where the heatmap should be created.</span>
<span class="sd">    comparison_out: dict</span>
<span class="sd">        A dictionary containing the output of the `comparison_scores` method of</span>
<span class="sd">        the `dpet.ensemble_analysis.EnsembleAnalysis` class. It must contain the</span>
<span class="sd">        following key-value pairs:</span>
<span class="sd">        `scores`: NumPy array with shape (M, M, B) containing the comparison</span>
<span class="sd">        scores for M ensembles and B bootstrap iterations. If no bootstrap</span>
<span class="sd">        analysis was performed, `B = 1`, otherwise it will be `B &gt; 1`.</span>
<span class="sd">        `p_values` (optional): used only when a bootstrap analysis was</span>
<span class="sd">        performed. A (M, M) NumPy array storiging the p-values obtained</span>
<span class="sd">        by comparing with a statistical test the inter-ensemble and</span>
<span class="sd">        intra-ensemble comparison scores.</span>
<span class="sd">    codes: List[str]</span>
<span class="sd">        List of strings with the codes of the ensembles.</span>
<span class="sd">    confidence_level: float, optional</span>
<span class="sd">        Condifence level for the bootstrap intervals of the comparison scores.</span>
<span class="sd">    significance_level: float, optional</span>
<span class="sd">        Significance level for the statistical test used to compare inter and</span>
<span class="sd">        intra-ensemble comparison scores.</span>
<span class="sd">    cmap: str, optional</span>
<span class="sd">        Matplotlib colormap name to use in the heatmap.</span>
<span class="sd">    title: str, optional</span>
<span class="sd">        Title of the heatmap.</span>
<span class="sd">    cbar_label: str, optional</span>
<span class="sd">        Label of the colorbar.</span>
<span class="sd">    textcolors: Union[str, tuple], optional</span>
<span class="sd">        Color of the text for each cell of the heatmap, specified as a string.</span>
<span class="sd">        By providing a tuple with two elements, the two colors will be applied</span>
<span class="sd">        to cells with color intensity above/below a certain threshold, so that</span>
<span class="sd">        ligher text can be plotted in darker cells and darker text can be</span>
<span class="sd">        plotted in lighter cells.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ax: plt.Axes</span>
<span class="sd">        The same updated Axes object from the input. The `comparison_out` will</span>
<span class="sd">        be updated to store confidence intervals if performing a bootstrap</span>
<span class="sd">        analysis.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The comparison matrix is annotated with the scores, and the axes are labeled</span>
<span class="sd">    with the ensemble labels.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>

    
    <span class="n">comparison_out</span> <span class="o">=</span> <span class="n">process_all_vs_all_output</span><span class="p">(</span>
        <span class="n">comparison_out</span><span class="o">=</span><span class="n">comparison_out</span><span class="p">,</span> <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span>
    <span class="p">)</span>
    <span class="n">scores_mean</span> <span class="o">=</span> <span class="n">comparison_out</span><span class="p">[</span><span class="s1">&#39;scores_mean&#39;</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">scores_mean</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># size and padding can be adjusted</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cbar_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># adjust font size here</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> 
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;anchor&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span>

    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">textcolors</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">color_ij</span> <span class="o">=</span> <span class="n">textcolors</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">scores_mean</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
                <span class="n">color_ij</span> <span class="o">=</span> <span class="n">textcolors</span><span class="p">[</span><span class="n">text_idx</span><span class="p">]</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color_ij</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">comparison_out</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
                <span class="n">label_ij</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scores_mean</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">label_ij</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">elif</span> <span class="n">comparison_out</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">:</span>
                <span class="n">_low_ij</span> <span class="o">=</span> <span class="n">comparison_out</span><span class="p">[</span><span class="s1">&#39;confidence_intervals&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_high_ij</span> <span class="o">=</span> <span class="n">comparison_out</span><span class="p">[</span><span class="s1">&#39;confidence_intervals&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">label_ij</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">_low_ij</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">_high_ij</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">comparison_out</span><span class="p">[</span><span class="s1">&#39;p_values&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">significance_level</span><span class="p">:</span>
                    <span class="n">label_ij</span> <span class="o">+=</span> <span class="s2">&quot;*&quot;</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">label_ij</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_random_a_angle_ids</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">prot_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">prot_len</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">torsion_ids</span> <span class="o">=</span> <span class="n">_get_a_angle_ids</span><span class="p">(</span><span class="n">rand_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torsion_ids</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_a_angle_ids</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
    <span class="n">torsion_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="n">torsion_ids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">torsion_ids</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_random_pairs</span><span class="p">(</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">prot_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">min_sep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">prot_len</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">min_sep</span><span class="p">)</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">pairs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pairs</span><span class="p">[</span><span class="n">rand_ids</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_to_array</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">_phi_psi_offsets</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;psi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_max_plots_in_grid</span><span class="p">(</span><span class="n">min_len</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;ca_dist&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">min_len</span><span class="o">*</span><span class="p">(</span><span class="n">min_len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;a_angle&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">min_len</span><span class="o">-</span><span class="mi">3</span>
    <span class="k">elif</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;psi&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">min_len</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rama&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">min_len</span><span class="o">-</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>


<span class="n">legend_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># &quot;loc&quot;: &#39;upper right&#39;, &quot;bbox_to_anchor&quot;: (1.1, 1.1),</span>
    <span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">8</span>
<span class="p">}</span>

<div class="viewcode-block" id="Visualization">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Visualization</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualization class for ensemble analysis.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        analysis (EnsembleAnalysis): An instance of EnsembleAnalysis providing data for visualization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">:</span> <span class="n">EnsembleAnalysis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span> <span class="o">=</span> <span class="n">analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">PLOT_DIR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_index_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>
        <span class="n">model_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">trajectories</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="n">ensemble</span><span class="p">]</span><span class="o">.</span><span class="n">n_frames</span><span class="p">):</span>
                <span class="n">model_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model</span><span class="si">{</span><span class="n">frame</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">ensemble</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_indexes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_tsne_scatter</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">color_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rg&quot;</span><span class="p">,</span>
            <span class="n">kde_by_ensemble</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">plotly</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">cmap_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the results of t-SNE analysis. </span>

<span class="sd">        Three scatter plots will be generated based on original, clustering, and feature-colored points. </span>
<span class="sd">        One KDE density plot will also be generated to show the most populated areas in the reduced dimension.   </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color_by: str, optional</span>
<span class="sd">            The feature extraction method used for coloring points in the scatter plot.</span>
<span class="sd">            Options are &quot;rg&quot;, &quot;prolateness&quot;, &quot;asphericity&quot;, &quot;sasa&quot;, and &quot;end_to_end&quot;. Default is &quot;rg&quot;.</span>
<span class="sd">        kde_by_ensemble: bool, optional</span>
<span class="sd">            If True, the KDE plot will be generated for each ensemble separately. </span>
<span class="sd">            If False, a single KDE plot will be generated for the concatenated ensembles. Default is True.</span>
<span class="sd">        save: bool, optional</span>
<span class="sd">            If True, the plot will be saved in the data directory. Default is False.</span>
<span class="sd">        ax: Union[None, plt.Axes, np.ndarray, List[plt.Axes]], optional</span>
<span class="sd">            The axes on which to plot. If None, new axes will be created. Default is None.</span>
<span class="sd">        size: int, optional </span>
<span class="sd">            The size of the points in the scatter plots. Default is 10.</span>
<span class="sd">        plotly: bool, optional </span>
<span class="sd">            If True, the plot will be generated using Plotly. Default is False.</span>
<span class="sd">        cmap_label: str, optional </span>
<span class="sd">            The colormap to use for the feature-colored labels. Default is &#39;viridis&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[plt.Axes]</span>
<span class="sd">            List containing Axes objects for the scatter plot of original labels, clustering labels, feature-colored labels, and the KDE density plot, respectively.</span>

<span class="sd">        Notes</span>
<span class="sd">        ------</span>
<span class="sd">        This analysis is only valid for t-SNE dimensionality reduction.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>

        <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span> <span class="o">!=</span> <span class="s2">&quot;tsne&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Analysis is only valid for t-SNE dimensionality reduction.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">color_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rg&quot;</span><span class="p">,</span> <span class="s2">&quot;prolateness&quot;</span><span class="p">,</span> <span class="s2">&quot;asphericity&quot;</span><span class="p">,</span> <span class="s2">&quot;sasa&quot;</span><span class="p">,</span> <span class="s2">&quot;end_to_end&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method </span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>

        <span class="n">bestclust</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_kmeans</span><span class="o">.</span><span class="n">labels_</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
          
        <span class="k">else</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
            
        <span class="c1"># Create a consistent colormap for the original labels</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">all_labels</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)))</span>
        <span class="n">label_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">color</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">)}</span>
        <span class="n">point_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_colors</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">all_labels</span><span class="p">]</span>

        <span class="c1"># Scatter plot with original labels</span>
        <span class="n">scatter_labeled</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">point_colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Scatter Plot (Ensemble labels)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="c1"># Scatter plot with clustering labels</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">bestK</span><span class="p">)</span>
        <span class="n">scatter_cluster</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">bestclust</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Scatter Plot (Clustering labels)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">feature_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get_features</span><span class="p">(</span><span class="n">color_by</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">feature_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feature_values</span><span class="p">)</span>
        <span class="c1"># Scatter plot with different labels</span>
        
        <span class="n">feature_labeled</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_label</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">feature_labeled</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rg&#39;</span><span class="p">,</span> <span class="s1">&#39;end_to_end&#39;</span><span class="p">):</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> [nm]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;prolateness&#39;</span><span class="p">,</span> <span class="s1">&#39;asphericity&#39;</span><span class="p">):</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">color_by</span> <span class="o">==</span> <span class="s1">&#39;sasa&#39;</span><span class="p">:</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;SASA [nm^2]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scatter Plot (</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> labels)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kde_by_ensemble</span><span class="p">:</span>
            <span class="c1"># KDE plot for each ensemble</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
                <span class="n">ensemble_data</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">all_labels</span><span class="p">)</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
                <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">([</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>
                <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span><span class="mi">100</span><span class="n">j</span><span class="p">,</span>
                                <span class="nb">min</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span><span class="mi">100</span><span class="n">j</span><span class="p">]</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xi</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">label_colors</span><span class="p">[</span><span class="n">label</span><span class="p">]],</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Density Plot (Ensemble-wise)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="c1"># ax[3].legend(title=&#39;Ensemble&#39;, loc=&#39;upper right&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single KDE plot for concatenated ensembles</span>
            <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">([</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span><span class="mi">100</span><span class="n">j</span><span class="p">,</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span><span class="mi">100</span><span class="n">j</span><span class="p">]</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xi</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Density Plot&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="c1"># Manage legend for the original labels</span>
        <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">label_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">label_colors</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Ensemble Labels&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.09</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plotly</span><span class="p">:</span>
            <span class="c1"># df = pd.DataFrame({&#39;x&#39;:analysis.reducer.best_tsne[:, 0], &#39;y&#39;: analysis.reducer.best_tsne[:, 1], &#39;index&#39;: range(len(analysis.reducer.best_tsne[:, 0]))})</span>
            <span class="n">fig_plotly</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> 
                            <span class="n">y</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">hover_data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_models</span><span class="p">()},</span>
                            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;t-SNE 1&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;t-SNE 2&#39;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rg&#39;</span><span class="p">,</span> <span class="s1">&#39;end_to_end&#39;</span><span class="p">):</span>
                <span class="n">fig_plotly</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">colorbar_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> [nm]&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;prolateness&#39;</span><span class="p">,</span> <span class="s1">&#39;asphericity&#39;</span><span class="p">):</span>
                <span class="n">fig_plotly</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">colorbar_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">color_by</span> <span class="o">==</span> <span class="s1">&#39;sasa&#39;</span><span class="p">:</span>
                <span class="n">fig_plotly</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">colorbar_title</span><span class="o">=</span><span class="s1">&#39;SASA [nm^2]&#39;</span><span class="p">)</span>
            <span class="n">fig_plotly</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;tsne_scatter_</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;t-SNE scatter plot saved to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;tsne_scatter_</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span>
    
<div class="viewcode-block" id="Visualization.dimensionality_reduction_scatter">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.dimensionality_reduction_scatter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dimensionality_reduction_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="n">color_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rg&quot;</span><span class="p">,</span> 
                                         <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                                         <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="n">kde_by_ensemble</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                                         <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                         <span class="n">plotly</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="n">cmap_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                                         <span class="n">n_components</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the results of dimensionality reduction using the method specified in the analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color_by : str, optional</span>
<span class="sd">            The feature extraction method used for coloring points in the scatter plot. Options are &quot;rg&quot;, &quot;prolateness&quot;, &quot;asphericity&quot;, &quot;sasa&quot;, and &quot;end_to_end&quot;. Default is &quot;rg&quot;.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved in the data directory. Default is False.</span>
<span class="sd">        ax : Union[None, List[plt.Axes]], optional</span>
<span class="sd">            A list of Axes objects to plot on. Default is None, which creates new axes.</span>
<span class="sd">        kde_by_ensemble : bool, optional</span>
<span class="sd">            If True, the KDE plot will be generated for each ensemble separately. </span>
<span class="sd">            If False, a single KDE plot will be generated for the concatenated ensembles. Default is False.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        size : int, optional</span>
<span class="sd">            The size of the points in the scatter plot. Default is 10.</span>
<span class="sd">        plotly : bool, optional</span>
<span class="sd">            If True, the plot will be generated using Plotly. Default is False.</span>
<span class="sd">        cmap_label : str, optional</span>
<span class="sd">            The colormap to use for the feature-colored labels. Default is &#39;viridis&#39;.</span>
<span class="sd">        n_components : int, optional</span>
<span class="sd">            The number of components for dimensionality reduction.</span>
<span class="sd">            </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[plt.Axes]</span>
<span class="sd">            List containing Axes objects for the scatter plot of original labels, clustering labels, and feature-colored labels, respectively.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            If the dimensionality reduction method specified in the analysis is not supported.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dimenfix&quot;</span><span class="p">,</span> <span class="s2">&quot;umap&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n_components</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_umap_scatter</span><span class="p">(</span><span class="n">color_by</span><span class="o">=</span><span class="n">color_by</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">kde_by_ensemble</span><span class="o">=</span><span class="n">kde_by_ensemble</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">plotly</span><span class="o">=</span><span class="n">plotly</span><span class="p">,</span> <span class="n">cmap_label</span><span class="o">=</span><span class="n">cmap_label</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;tsne&quot;</span> <span class="ow">and</span> <span class="n">n_components</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tsne_scatter</span><span class="p">(</span><span class="n">color_by</span><span class="o">=</span><span class="n">color_by</span><span class="p">,</span> <span class="n">kde_by_ensemble</span><span class="o">=</span><span class="n">kde_by_ensemble</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">cmap_label</span><span class="o">=</span><span class="n">cmap_label</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">plotly</span><span class="o">=</span><span class="n">plotly</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n_components</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_3d</span><span class="p">(</span><span class="n">color_by</span><span class="o">=</span><span class="n">color_by</span><span class="p">,</span> <span class="n">kde_by_ensemble</span><span class="o">=</span><span class="n">kde_by_ensemble</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">plotly</span><span class="o">=</span><span class="n">plotly</span><span class="p">,</span> <span class="n">cmap_label</span><span class="o">=</span><span class="n">cmap_label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scatter plot for method &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39; is not implemented. Please select between &#39;tsne&#39;, &#39;dimenfix&#39;, and &#39;umap&#39;.&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_umap_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                         <span class="n">color_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rg&quot;</span><span class="p">,</span> 
                         <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span> 
                         <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">kde_by_ensemble</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                         <span class="n">plotly</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                         <span class="n">cmap_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span> 
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the complete results for dimenfix and umap methods. </span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        color_by: str, optional</span>
<span class="sd">            The feature extraction method used for coloring points in the scatter plot. Options are &quot;rg&quot;, &quot;prolateness&quot;, &quot;asphericity&quot;, &quot;sasa&quot;, and &quot;end_to_end&quot;. Default is &quot;rg&quot;.</span>

<span class="sd">        save: bool, optional</span>
<span class="sd">            If True, the plot will be saved in the data directory. Default is False.</span>

<span class="sd">        ax : Union[None, List[plt.Axes]], optional</span>
<span class="sd">            A list of Axes objects to plot on. Default is None, which creates new axes.</span>
<span class="sd">        </span>
<span class="sd">        kde_by_ensemble: bool, optional</span>
<span class="sd">            If True, the KDE plot will be generated for each ensemble separately. If False, a single KDE plot will be generated for the concatenated ensembles. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        List[plt.Axes]</span>
<span class="sd">            List containing Axes objects for the scatter plot of original labels, clustering labels, and feature-colored labels, respectively.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>

        <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dimenfix&quot;</span><span class="p">,</span> <span class="s2">&quot;umap&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Analysis is only valid for dimenfix dimensionality reduction.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">color_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rg&quot;</span><span class="p">,</span> <span class="s2">&quot;prolateness&quot;</span><span class="p">,</span> <span class="s2">&quot;asphericity&quot;</span><span class="p">,</span> <span class="s2">&quot;sasa&quot;</span><span class="p">,</span> <span class="s2">&quot;end_to_end&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method </span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Ensure axes is a 1D array</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ax_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">ax_array</span>  <span class="c1"># If ax is provided, flatten it to 1D</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># Create a consistent colormap for the original labels</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">all_labels</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)))</span>
        <span class="n">label_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">color</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">)}</span>
        <span class="n">point_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_colors</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">all_labels</span><span class="p">]</span>

        <span class="c1"># Scatter plot with original labels</span>
        
        <span class="n">scatter_labeled</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">point_colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Scatter Plot (Ensemble labels)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;UMAP 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;UMAP 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>


        <span class="c1"># Scatter plot with different labels</span>
        <span class="n">feature_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get_features</span><span class="p">(</span><span class="n">color_by</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">feature_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feature_values</span><span class="p">)</span>

        
        <span class="n">rg_labeled</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_label</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">rg_labeled</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scatter Plot (</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> labels)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rg&#39;</span><span class="p">,</span> <span class="s1">&#39;end_to_end&#39;</span><span class="p">):</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> [nm]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;prolateness&#39;</span><span class="p">,</span> <span class="s1">&#39;asphericity&#39;</span><span class="p">):</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">color_by</span> <span class="o">==</span> <span class="s1">&#39;sasa&#39;</span><span class="p">:</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;SASA [nm^2]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;UMAP 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;UMAP 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        

        <span class="c1"># Scatter plot with clustering labels</span>
        <span class="n">best_k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">sil_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;best_k is &#39;</span><span class="p">,</span> <span class="n">best_k</span><span class="p">)</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">best_k</span><span class="p">,</span><span class="n">n_init</span><span class="o">=</span><span class="mi">10</span> <span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">)</span>
        <span class="n">scatter_cluster</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Scatter Plot (clustering labels)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;UMAP 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;UMAP 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="c1"># Manage legend for original labels</span>
        <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">label_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">label_colors</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span><span class="p">]</span>
        

        <span class="k">if</span> <span class="n">kde_by_ensemble</span><span class="p">:</span>
            <span class="c1"># KDE plot for each ensemble</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
                <span class="n">ensemble_data</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">all_labels</span><span class="p">)</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
                <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">([</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>
                <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span><span class="mi">100</span><span class="n">j</span><span class="p">,</span>
                                <span class="nb">min</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span><span class="mi">100</span><span class="n">j</span><span class="p">]</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xi</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">label_colors</span><span class="p">[</span><span class="n">label</span><span class="p">]])</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Density Plot (Ensemble-wise)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="c1"># ax[3].legend(title=&#39;Ensemble&#39;, loc=&#39;upper right&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single KDE plot for concatenated ensembles</span>
            <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">([</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span><span class="mi">100</span><span class="n">j</span><span class="p">,</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span><span class="mi">100</span><span class="n">j</span><span class="p">]</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xi</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Density Plot&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;UMAP 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;UMAP 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Ensemble Labels&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.09</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span><span class="si">}</span><span class="s1">_scatter.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;UMAP scatter plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span><span class="si">}</span><span class="s1">_scatter.png&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">plotly</span><span class="p">:</span>
            <span class="c1"># df = pd.DataFrame({&#39;x&#39;:analysis.reducer.best_tsne[:, 0], &#39;y&#39;: analysis.reducer.best_tsne[:, 1], &#39;index&#39;: range(len(analysis.reducer.best_tsne[:, 0]))})</span>
            <span class="n">fig_plotly</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="n">y</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
                            <span class="n">hover_data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_models</span><span class="p">()},</span>
                            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;UMAP 1&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;UMAP 2&#39;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rg&#39;</span><span class="p">,</span> <span class="s1">&#39;end_to_end&#39;</span><span class="p">):</span>
                <span class="n">fig_plotly</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">colorbar_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> [nm]&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;prolateness&#39;</span><span class="p">,</span> <span class="s1">&#39;asphericity&#39;</span><span class="p">):</span>
                <span class="n">fig_plotly</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">colorbar_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">color_by</span> <span class="o">==</span> <span class="s1">&#39;sasa&#39;</span><span class="p">:</span>
                <span class="n">fig_plotly</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">colorbar_title</span><span class="o">=</span><span class="s1">&#39;SASA [nm^2]&#39;</span><span class="p">)</span>
            <span class="n">fig_plotly</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">axes</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_scatter_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                    <span class="n">color_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rg&quot;</span><span class="p">,</span> 
                    <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                    <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="n">kde_by_ensemble</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">plotly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">cmap_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> 
                    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rg&#39;</span><span class="p">,</span> <span class="s1">&#39;end_to_end&#39;</span><span class="p">):</span>
            <span class="n">colorbar_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> [nm]&#39;</span>
        <span class="k">elif</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;prolateness&#39;</span><span class="p">,</span> <span class="s1">&#39;asphericity&#39;</span><span class="p">):</span>
            <span class="n">colorbar_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">color_by</span> <span class="o">==</span> <span class="s1">&#39;sasa&#39;</span><span class="p">:</span>
            <span class="n">colorbar_title</span> <span class="o">=</span> <span class="s1">&#39;SASA [nm^2]&#39;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>

        <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dimenfix&quot;</span><span class="p">,</span> <span class="s2">&quot;umap&quot;</span><span class="p">):</span>
            <span class="n">ax_label</span> <span class="o">=</span> <span class="s1">&#39;t-SNE&#39;</span>
            <span class="n">bestclust</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">best_kmeans</span><span class="o">.</span><span class="n">labels_</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Set1&#39;</span><span class="p">,</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">bestK</span><span class="p">)</span>
            <span class="n">labels_clust</span> <span class="o">=</span> <span class="n">bestclust</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax_label</span> <span class="o">=</span> <span class="s1">&#39;UMAP&#39;</span>
            <span class="n">best_k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">sil_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">best_k</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
            <span class="n">labels_clust</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">)</span>
            
            
            
        
        <span class="k">if</span> <span class="n">color_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rg&quot;</span><span class="p">,</span> <span class="s2">&quot;prolateness&quot;</span><span class="p">,</span> <span class="s2">&quot;asphericity&quot;</span><span class="p">,</span> <span class="s2">&quot;sasa&quot;</span><span class="p">,</span> <span class="s2">&quot;end_to_end&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method </span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            
            <span class="c1"># axes = ax.flatten()  # Ensure axes is a 1D array</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">ax_array</span>  <span class="c1"># If ax is provided, flatten it to 1D</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># Create a consistent colormap for the original labels</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">all_labels</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;plasma&#39;</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)))</span>
        <span class="n">label_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">color</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">,</span> <span class="n">colors</span><span class="p">)}</span>
        <span class="n">point_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_colors</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">all_labels</span><span class="p">]</span>

        <span class="c1"># Scatter plot with original labels</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">scatter_labeled</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">point_colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Scatter plot (original labels)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">135</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 1&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 2&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 3&#39;</span><span class="p">)</span>

        <span class="c1"># Scatter plot with different labels</span>
        <span class="n">feature_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get_features</span><span class="p">(</span><span class="n">color_by</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">feature_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feature_values</span><span class="p">)</span>


        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">rg_labeled</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_label</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">rg_labeled</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.075</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">colorbar_title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scatter plot (</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> labels)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 1&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 2&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 3&#39;</span><span class="p">)</span>

        <span class="c1"># Scatter plot with clustering labels</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels_clust</span><span class="p">))</span>
        <span class="n">cluster_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Set1&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)</span>
        <span class="n">colors_discrete</span> <span class="o">=</span> <span class="n">cluster_cmap</span><span class="p">(</span><span class="n">labels_clust</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="n">scatter_cluster</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="n">colors_discrete</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>

        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Scatter plot (clustering labels)&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">135</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 1&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 2&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 3&#39;</span><span class="p">)</span>

        <span class="c1"># Manage legend for original labels</span>
        <span class="n">legend_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">label_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">label_colors</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">legend_labels</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Original Labels&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plotly</span><span class="p">:</span>
            <span class="c1"># df = pd.DataFrame({&#39;x&#39;:analysis.reducer.best_tsne[:, 0], &#39;y&#39;: analysis.reducer.best_tsne[:, 1], &#39;index&#39;: range(len(analysis.reducer.best_tsne[:, 0]))})</span>
            <span class="c1"># fig = px.scatter(x=analysis.transformed_data[:, 0], y=analysis.transformed_data[:, 1], color=colors, hover_data={&#39;index&#39;:self._index_models()} )</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pc</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
            <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels_clust</span><span class="p">))</span>
            <span class="n">color_list</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Set1</span>  <span class="c1"># or Set2, Dark2, Pastel, etc.</span>

            <span class="c1"># Extend color list if not enough colors</span>
            <span class="k">if</span> <span class="n">n_clusters</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_list</span><span class="p">):</span>
                <span class="n">color_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">color_list</span> <span class="o">*</span> <span class="p">((</span><span class="n">n_clusters</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_list</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[:</span><span class="n">n_clusters</span><span class="p">]</span>

            <span class="c1"># Map cluster ID to color</span>
            <span class="n">label_color_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">color_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)}</span>
            <span class="n">labels_colors_discrete</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_color_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels_clust</span><span class="p">]</span>
         

            <span class="n">fig_plotly</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
                <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scene&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scene&#39;</span><span class="p">}</span> <span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scene&#39;</span><span class="p">}]],</span>
                <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Ensemble Labels&#39;</span><span class="p">,</span> <span class="s1">&#39;Clustering Labels&#39;</span> <span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_by</span><span class="si">}</span><span class="s1"> Labels&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">fig_plotly</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">])),</span>
                <span class="n">scene2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.34</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">])),</span>
                <span class="n">scene3</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]))</span>
<span class="p">)</span>
            <span class="c1"># Plot 1: Ensemble Labels</span>
            <span class="n">fig_plotly</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">point_colors</span><span class="p">,</span>
                        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                             
                    <span class="p">),</span>
                    <span class="n">hovertext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_models</span><span class="p">(),</span>
                   
                <span class="p">),</span>
                <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Plot 2: Clustering Labels</span>
            <span class="n">fig_plotly</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">labels_colors_discrete</span><span class="p">,</span>
                        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                
                    <span class="p">),</span>
                    <span class="n">hovertext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_models</span><span class="p">(),</span>
                   
                <span class="p">),</span>
                <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="c1"># Plot 3: Feature Colored Labels</span>
            <span class="n">fig_plotly</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
                        <span class="n">colorscale</span><span class="o">=</span><span class="n">cmap_label</span><span class="p">,</span>
                        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                        <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">colorbar_title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="nb">len</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                            <span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">hovertext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_models</span><span class="p">(),</span>
                    
                <span class="p">),</span>
                <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">3</span>
            <span class="p">),</span>

            <span class="c1"># Axis labels for both 3D plots</span>
            <span class="n">fig_plotly</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">xaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 1&#39;</span><span class="p">,</span>
                    <span class="n">yaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 2&#39;</span><span class="p">,</span>
                    <span class="n">zaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 3&#39;</span>
                <span class="p">),</span>
                <span class="n">scene2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">xaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 1&#39;</span><span class="p">,</span>
                    <span class="n">yaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 2&#39;</span><span class="p">,</span>
                    <span class="n">zaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 3&#39;</span>
                <span class="p">),</span>
                <span class="n">scene3</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">xaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 1&#39;</span><span class="p">,</span>
                    <span class="n">yaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 2&#39;</span><span class="p">,</span>
                    <span class="n">zaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ax_label</span><span class="si">}</span><span class="s1"> 3&#39;</span>
                <span class="p">),</span>
                
                <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">fig_plotly</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># Adjust spacing manually</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;tSNE_landscape&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;3D scatter plot saved to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tSNE_landscape.png&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span>


<div class="viewcode-block" id="Visualization.pca_cumulative_explained_variance">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.pca_cumulative_explained_variance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pca_cumulative_explained_variance</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span> <span class="p">,</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the cumulative variance. Only applicable when the</span>
<span class="sd">        dimensionality reduction method is &quot;pca&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save: bool, optional</span>
<span class="sd">            If True, the plot will be saved in the data directory. Default is False.</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        ax: Union[None, plt.Axes], optional</span>
<span class="sd">            An Axes object to plot on. Default is None, which creates a new axes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes, cumvar</span>
<span class="sd">            The Axes object for the cumulative explained variance plot and a</span>
<span class="sd">            numpy array with the cumulative variance.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>

        <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span> <span class="o">!=</span> <span class="s2">&quot;pca&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Analysis is only valid for pca dimensionality reduction.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">pc_vars</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_model</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
        <span class="n">cumvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pc_vars</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cumvar</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PCA dimension&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative explained variance %&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cumulative Explained Variance by PCA Dimension&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">first_three_variance</span> <span class="o">=</span> <span class="n">pc_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;First three: </span><span class="si">{</span><span class="n">first_three_variance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;PCA_variance&#39;</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PCA cumulative explained variance plot saved to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PCA_variance&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.png&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cumvar</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_set_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">reduce_dim_method</span><span class="p">,</span> <span class="n">dim_x</span><span class="p">,</span> <span class="n">dim_y</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reduce_dim_method</span><span class="si">}</span><span class="s2"> dim </span><span class="si">{</span><span class="n">dim_x</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reduce_dim_method</span><span class="si">}</span><span class="s2"> dim </span><span class="si">{</span><span class="n">dim_y</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_dimred_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No dimensionality reduction was performed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allowed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Analysis is only valid for the following dimensionality reduction methods: </span><span class="si">{</span><span class="n">allowed</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

<div class="viewcode-block" id="Visualization.pca_2d_landscapes">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.pca_2d_landscapes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pca_2d_landscapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">sel_components</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot 2D landscapes when the dimensionality reduction method is &quot;pca&quot; or &quot;kpca&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save: bool, optional</span>
<span class="sd">            If True the plot will be saved in the data directory. Default is False.</span>
<span class="sd">        sel_components: List[int], optional</span>
<span class="sd">            Indices of the selected principal components to analyze, starting from 0.</span>
<span class="sd">            The default components are the first and second.</span>
<span class="sd">        ax: Union[None, List[plt.Axes]], optional</span>
<span class="sd">            A list of Axes objects to plot on. Default is None, which creates new axes.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            For changing the quality and dimension of the output figure. Default is 96.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[plt.Axes]</span>
<span class="sd">            A list of plt.Axes objects representing the subplots created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dimred_method</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="s2">&quot;kpca&quot;</span><span class="p">))</span>

        <span class="c1"># 2D scatter plot settings</span>
        <span class="n">dim_x</span> <span class="o">=</span> <span class="n">sel_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dim_y</span> <span class="o">=</span> <span class="n">sel_components</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

        <span class="n">num_ensembles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">num_ensembles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_ensembles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># Plot all ensembles at the same time</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">reduce_dim_data</span><span class="p">[:,</span> <span class="n">dim_x</span><span class="p">],</span>
                            <span class="n">ensemble</span><span class="o">.</span><span class="n">reduce_dim_data</span><span class="p">[:,</span> <span class="n">dim_y</span><span class="p">],</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">legend_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_labels</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">dim_x</span><span class="p">,</span> <span class="n">dim_y</span><span class="p">)</span>

        <span class="c1"># Concatenate all reduced dimensionality data from the dictionary</span>
        <span class="n">all_data</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span>

        <span class="c1"># Plot each ensemble individually</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="c1"># Plot all data in gray</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_data</span><span class="p">[:,</span> <span class="n">dim_x</span><span class="p">],</span>
                                <span class="n">all_data</span><span class="p">[:,</span> <span class="n">dim_y</span><span class="p">],</span>
                                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span>
            <span class="c1"># Plot ensemble data in color</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">reduce_dim_data</span><span class="p">[:,</span> <span class="n">dim_x</span><span class="p">],</span>
                                <span class="n">ensemble</span><span class="o">.</span><span class="n">reduce_dim_data</span><span class="p">[:,</span> <span class="n">dim_y</span><span class="p">],</span>
                                <span class="n">label</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">legend_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_labels</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">dim_x</span><span class="p">,</span> <span class="n">dim_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_2d_landscapes_&#39;</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span> <span class="o">+</span> 
                        <span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> 2D landscapes saved to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_2d_landscapes_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.png&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="Visualization.pca_1d_histograms">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.pca_1d_histograms">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pca_1d_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">sel_components</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot 1D histogram when the dimensionality reduction method is &quot;pca&quot; or &quot;kpca&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save: bool, optional</span>
<span class="sd">            If True the plot will be saved in the data directory. Default is False.</span>

<span class="sd">        dim: int, optional</span>
<span class="sd">            To select the specific component (dimension) for which you want to visualize the histogram distribution.</span>
<span class="sd">            Default is 0 (first principal component in PCA). </span>

<span class="sd">        n_bins: int, optional</span>
<span class="sd">            Number of bins in the histograms.</span>

<span class="sd">        ax: Union[None, List[plt.Axes]], optional</span>
<span class="sd">            A list of Axes objects to plot on. Default is None, which creates new axes.</span>
<span class="sd">        </span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            For changing the quality and dimension of the output figure. Default is 96.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[plt.Axes]</span>
<span class="sd">            A list of plt.Axes objects representing the subplots created.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dimred_method</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="s2">&quot;kpca&quot;</span><span class="p">))</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">sel_components</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                           <span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                           <span class="n">bins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">)),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># Plot histograms for each ensemble</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">reduce_dim_data</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">transformed_data</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                        <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">legend_kwargs</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2"> dim </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_hist&#39;</span> <span class="o">+</span> 
                        <span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> 1D histograms saved to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_hist&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.png&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="Visualization.pca_residue_correlation">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.pca_residue_correlation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pca_residue_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">sel_components</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
            <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">,</span>
            <span class="n">cmap_range</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">scale_loadings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the loadings (weights) of each pair of residues for a list of</span>
<span class="sd">        principal components (PCs).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sel_components : List[int], optional</span>
<span class="sd">            A list of indices specifying the PC to include in the plot.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file. Default is False.</span>
<span class="sd">        ax : Union[None, List[plt.Axes]], optional</span>
<span class="sd">            A list of Axes objects to plot on. Default is None, which creates new axes.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            For changing the quality and dimension of the output figure. Default is 96.</span>
<span class="sd">        cmap: str, optional</span>
<span class="sd">            Matplotlib colormap name.</span>
<span class="sd">        cmap_range: Union[None, Tuple[float]], optional</span>
<span class="sd">            Range of the colormap. Defaults to &#39;None&#39;, the range will be</span>
<span class="sd">            identified automatically. If a tuple, the first and second elements</span>
<span class="sd">            are the min. and max. of the range.</span>
<span class="sd">        scale_loadings: bool, optional</span>
<span class="sd">            Scale loadings by explained variance. Some definitions use correlation</span>
<span class="sd">            coefficients as loadings, when input features are standardized.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[plt.Axes]</span>
<span class="sd">            A list of plt.Axes objects representing the subplots created.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method generates a correlation plot showing the weights of pairwise residue distances</span>
<span class="sd">        for selected PCA dimensions. The plot visualizes the correlation between residues based on</span>
<span class="sd">        the PCA weights.</span>

<span class="sd">        The analysis is only valid on PCA and kernel PCA dimensionality reduction with &#39;ca_dist&#39; feature extraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>

        <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span> <span class="o">!=</span> <span class="s2">&quot;pca&quot;</span> <span class="ow">or</span> <span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span> <span class="o">!=</span> <span class="s2">&quot;ca_dist&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Analysis is only valid for pca dimensionality reduction with ca_dist feature extraction.&quot;</span><span class="p">)</span>
        
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

        <span class="n">fig_r</span> <span class="o">=</span> <span class="mf">0.8</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_components</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="o">*</span><span class="n">fig_r</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">fig_r</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># Get the number of residues from one of the trajectories</span>
        <span class="n">num_residues</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">trajectories</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">n_residues</span>
        <span class="n">pca_model</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_model</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">sel_component</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_components</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_residues</span><span class="p">,</span> <span class="n">num_residues</span><span class="p">))</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">scale_loadings</span><span class="p">:</span>
                <span class="n">loadings</span> <span class="o">=</span> <span class="n">pca_model</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pca_model</span><span class="o">.</span><span class="n">explained_variance_</span><span class="p">)</span>
                <span class="n">loadings</span> <span class="o">=</span> <span class="n">loadings</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loadings</span> <span class="o">=</span> <span class="n">pca_model</span><span class="o">.</span><span class="n">components_</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">loadings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="c1"># Note: this should be patched for proteins with resSeq values not starting from 1!</span>
                <span class="n">v_ij</span> <span class="o">=</span> <span class="n">loadings</span><span class="p">[</span><span class="n">sel_component</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">matrix</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">r1</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_ij</span>
                <span class="n">matrix</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">r1</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_ij</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_ij</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmap_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Automatically find the range.</span>
                <span class="n">_cmap_range</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_cmap_range</span> <span class="o">=</span> <span class="n">cmap_range</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">_cmap_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_cmap_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>  <span class="c1"># RdBu, PiYG</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Residue j&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Residue i&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Loading of $d_</span><span class="si">{ij}</span><span class="s2">$&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; for PCA dim </span><span class="si">{</span><span class="n">sel_component</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                <span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PCA loading&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;PCA_correlation&#39;</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PCA residue correlation plot saved to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PCA_correlation&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">featurization</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.png&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="Visualization.pca_rg_correlation">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.pca_rg_correlation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pca_rg_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
            <span class="n">sel_components</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examine and plot the correlation between PC dimension 1 and the amount of Rg.</span>
<span class="sd">        Typically high correlation can be detected in case of IDPs/IDRs .</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved in the data directory. Default is False.</span>

<span class="sd">        ax: Union[None, List[plt.Axes]], optional</span>
<span class="sd">            A list of Axes objects to plot on. Default is None, which creates new axes.</span>
<span class="sd">        </span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            For changing the quality and dimension of the output figure. Default is 96.</span>

<span class="sd">        sel_components: int, optional</span>
<span class="sd">            Index of the selected principal component to analyze, defaults to 0 (first</span>
<span class="sd">            principal component).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[plt.Axes], dict</span>
<span class="sd">            A list of plt.Axes objects representing the subplots created and a</span>
<span class="sd">            dictionary with all the raw data being plotted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>

        <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">reduce_dim_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="s2">&quot;kpca&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Analysis is only valid for pca and kpca dimensionality reduction.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">)),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># Plot the correlation for each ensemble</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
            <span class="n">rg_i</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_rg</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">reduce_dim_data</span><span class="p">[:,</span> <span class="n">sel_components</span><span class="p">],</span>
                            <span class="n">rg_i</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dim </span><span class="si">{</span><span class="n">sel_components</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$R_g$ [nm]&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pc&quot;</span><span class="p">:</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">reduce_dim_data</span><span class="p">[:,</span> <span class="n">sel_components</span><span class="p">],</span>
                <span class="s2">&quot;rg&quot;</span><span class="p">:</span> <span class="n">rg_i</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;PCA_RG&#39;</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PCA Rg correlation plot saved to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PCA_RG&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.png&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axes</span><span class="p">,</span> <span class="n">data</span></div>

    
<div class="viewcode-block" id="Visualization.global_sasa">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.global_sasa">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">global_sasa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
                <span class="n">hist_range</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                <span class="n">violin_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                <span class="n">summary_stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                <span class="n">dpi</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
                <span class="n">multiple_hist_ax</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">x_ticks_rotation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span>
                <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the distribution of SASA for each conformation within the ensembles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bins : int, optional</span>
<span class="sd">            The number of bins for the histogram. Default is 50.</span>
<span class="sd">        hist_range: Tuple, optional</span>
<span class="sd">            A tuple with a min and max value for the histogram. Default is None,</span>
<span class="sd">            which corresponds to using the min a max value across all data.</span>
<span class="sd">        violin_plot : bool, optional</span>
<span class="sd">            If True, a violin plot is visualized. Default is True.</span>
<span class="sd">        summary_stat: str, optional</span>
<span class="sd">            Specifies whether to display the &quot;mean&quot;, &quot;median&quot;, or &quot;both&quot; as reference lines on the plots.</span>
<span class="sd">            This applies when violin_plot is True or when multiple_hist_ax is True for histograms.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        color : str, optional</span>
<span class="sd">            Color of the violin plot. Default is lightblue.</span>
<span class="sd">        multiple_hist_ax : bool, optional</span>
<span class="sd">            If True, it will plot each histogram in a different axis.</span>
<span class="sd">        x_ticks_rotation : int, optional</span>
<span class="sd">            The rotation angle of the x-axis tick labels for the violin plot. Default is 45.</span>
<span class="sd">        ax : Union[None, plt.Axes, np.ndarray, List[plt.Axes]], optional</span>
<span class="sd">            The matplotlib Axes object on which to plot. If None, a new Axes object will be created. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">exists_coarse_grained</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This analysis is not possible with coarse-grained models.&quot;</span><span class="p">)</span>

        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>

        <span class="c1"># Calculate features.</span>
        <span class="n">hist_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">sasa_i</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">shrake_rupley</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">total_sasa_i</span> <span class="o">=</span> <span class="n">sasa_i</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">hist_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_sasa_i</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

        <span class="c1"># Plot setup depending on plot type and multiple_hist_ax setting</span>
        <span class="n">custom_axes</span> <span class="o">=</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">violin_plot</span> <span class="ow">and</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
            <span class="c1"># Create one axis for each histogram</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">),</span> 
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="mi">96</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single axis for all histograms or violin plot</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;SASA (nm$^2$)&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">violin_plot</span><span class="p">:</span>
            <span class="c1"># Plot the violin plot</span>
            <span class="n">plot_violins</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">summary_stat</span><span class="o">=</span><span class="n">summary_stat</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">x_ticks_rotation</span><span class="o">=</span><span class="n">x_ticks_rotation</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
                <span class="c1"># Single histogram plot</span>
                <span class="n">plot_histogram</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Plot separate histograms for each ensemble on separate axes</span>
                <span class="n">_bins</span> <span class="o">=</span> <span class="n">_get_hist_bins</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span>
                <span class="p">)</span>
                <span class="n">h_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;histtype&quot;</span><span class="p">:</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">hist_data_i</span> <span class="ow">in</span> <span class="n">hist_data</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name_i</span><span class="p">,</span> <span class="n">hist_data_i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">hist_data</span><span class="p">)):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name_i</span><span class="p">,</span> <span class="o">**</span><span class="n">h_args</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># Add a little margin</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name_i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axis_label</span><span class="p">)</span>

                    <span class="c1"># Adding mean/median/both lines with legend</span>
                    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                        <span class="n">mean_sasa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_sasa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                        <span class="n">median_sasa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_sasa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
                        <span class="n">mean_sasa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_sasa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                        <span class="n">median_sasa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_sasa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>

                    <span class="c1"># Add legend if needed</span>
                    <span class="k">if</span> <span class="n">legend_handles</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>            
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;Global_SASA_dist_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Global SASA distribution plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/Global_SASA_dist_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.rg_vs_asphericity">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.rg_vs_asphericity">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rg_vs_asphericity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                           <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                           <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the Rg versus Asphericity and calculates the pearson correlation coefficient to evaluate </span>
<span class="sd">        the correlation between Rg and Asphericity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        size: int, optional</span>
<span class="sd">            The size of the scatter points. Default is 4.</span>
<span class="sd">        ax: plt.Axes, optional</span>
<span class="sd">            The axes on which to plot. Default is None, which creates a new figure and axes.</span>
<span class="sd">        verbose: bool, optional</span>
<span class="sd">            Verbosity for the output of the method. Showin the Pearson correlation coefficient for each ensemble.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>  <span class="c1"># Create a new figure if ax is not provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>  <span class="c1"># Use the figure associated with the provided ax</span>
        
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_rg</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">compute_asphericity</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Pearson coeff for </span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Asphericity&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span> <span class="sa">r</span><span class="s2">&quot;Radius of Gyration ($R_g$) [nm]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rg vs. Asphericity&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;Rg_vs_Asphericity_&#39;</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rg vs. Asphericity plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/Rg_vs_Asphericity_</span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

  
<div class="viewcode-block" id="Visualization.rg_vs_prolateness">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.rg_vs_prolateness">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rg_vs_prolateness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                          <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                          <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                          <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                          <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the Rg versus Prolateness and get the Pearson correlation coefficient to evaluate </span>
<span class="sd">        the correlation between Rg and Prolateness. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        size: int, optional</span>
<span class="sd">            The size of the scatter marker points. Default is 4.</span>
<span class="sd">        save: bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        ax: plt.Axes, optional</span>
<span class="sd">            The axes on which to plot. Default is None, which creates a new figure and axes.</span>
<span class="sd">        verbose: bool, optional</span>
<span class="sd">            Verbosity for the output of the method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>  <span class="c1"># Create a new figure if ax is not provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>  <span class="c1"># Use the figure associated with the provided ax</span>

        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_rg</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">compute_prolateness</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Pearson coeff for </span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Prolateness&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Radius of Gyration ($R_g$) [nm]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rg vs. Prolateness&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;Rg_vs_Prolateness_&#39;</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rg vs. Prolateness plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/Rg_vs_Prolateness_</span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_protein_dssp_data_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">dssp_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">dssp_data_dict</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_dssp</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dssp_data_dict</span>
    
<div class="viewcode-block" id="Visualization.relative_dssp_content">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.relative_dssp_content">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">relative_dssp_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">dssp_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
            <span class="n">auto_xticks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">xtick_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the relative ss content in each ensemble for each residue. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dssp_code : str, optional</span>
<span class="sd">            The selected dssp code , it could be selected between &#39;H&#39; for Helix, &#39;C&#39; for Coil and &#39;E&#39; for strand. It works based on</span>
<span class="sd">            the simplified DSSP codes</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96. </span>
<span class="sd">        auto_xticks: bool, optional</span>
<span class="sd">            If True, use matplotlib default xticks.</span>
<span class="sd">        xtick_interval: int, optional</span>
<span class="sd">            If `auto_xticks` is False, this parameter defines the interval between displayed residue indices on the x-axis.</span>
<span class="sd">            Residue 1 is always included,followed by every `xtick_interval` residues (e.g., 1, 5, 10, 15 if `xtick_interval`=5).</span>
<span class="sd">        figsize : Tuple[float, float], optional</span>
<span class="sd">            The size of the figure in inches. Default is (10, 5).</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        ax : plt.Axes, optional</span>
<span class="sd">            The axes on which to plot. Default is None, which creates a new figure and axes.</span>



<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">exists_coarse_grained</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This analysis is not possible with coarse-grained models.&quot;</span><span class="p">)</span>
        
        <span class="n">protein_dssp_data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_protein_dssp_data_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">protein_dssp_data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">protein_name</span><span class="p">,</span> <span class="n">dssp_data</span> <span class="ow">in</span> <span class="n">protein_dssp_data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Count the occurrences of &#39;H&#39; in each column</span>
            <span class="n">ss_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">dssp_data</span> <span class="o">==</span> <span class="n">dssp_code</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Calculate the total number of residues for each position</span>
            <span class="n">total_residues</span> <span class="o">=</span> <span class="n">dssp_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Calculate the relative content of &#39;H&#39; for each residue</span>
            <span class="n">relative_ss_content</span> <span class="o">=</span> <span class="n">ss_counts</span> <span class="o">/</span> <span class="n">total_residues</span>

            <span class="c1"># Interpolate or pad the relative content to ensure all ensembles have the same length</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relative_ss_content</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
                <span class="n">relative_ss_content</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">relative_ss_content</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">relative_ss_content</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            
            <span class="c1"># Plot the relative content for each protein</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">relative_ss_content</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dssp_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Create a mask to filter out padded values</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">relative_ss_content</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">protein_name</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">bottom</span> <span class="o">+=</span> <span class="n">relative_ss_content</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_xticks</span><span class="p">:</span>

            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xtick_interval</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xtick_interval</span><span class="p">)]</span>
            <span class="n">tick_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tick_labels</span><span class="p">]</span>  <span class="c1"># convert to 0-based indexing</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tick_positions</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">tick_labels</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residue Index&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dssp_code</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">dssp_name</span> <span class="o">=</span> <span class="s1">&#39;Helix&#39;</span>
        <span class="k">elif</span> <span class="n">dssp_code</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
            <span class="n">dssp_name</span> <span class="o">=</span> <span class="s1">&#39;Coil&#39;</span>
        <span class="k">elif</span> <span class="n">dssp_code</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span>
            <span class="n">dssp_name</span> <span class="o">=</span> <span class="s1">&#39;Strand&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">dssp_code</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Relative Content of </span><span class="si">{</span><span class="n">dssp_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dssp_name</span><span class="si">}</span><span class="s1"> Content per Residue in the Ensemble&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="c1"># put the legend outside of the plot</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;relative_helix_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">ax</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_rg_data_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">rg_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">rg_dict</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_rg</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rg_dict</span>

<div class="viewcode-block" id="Visualization.radius_of_gyration">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.radius_of_gyration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">radius_of_gyration</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">hist_range</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">multiple_hist_ax</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">violin_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">x_ticks_rotation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span>
            <span class="n">summary_stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the distribution of the radius of gyration (Rg) within each ensemble.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bins : int, optional</span>
<span class="sd">            The number of bins for the histogram. Default is 50.</span>
<span class="sd">        hist_range : Tuple, optional</span>
<span class="sd">            A tuple with a min and max value for the histogram. Default is None,</span>
<span class="sd">            which corresponds to using the min and max value across all data.</span>
<span class="sd">        multiple_hist_ax: bool, optional</span>
<span class="sd">            If True, it will plot each histogram in a different axis.</span>
<span class="sd">        violin_plot : bool, optional</span>
<span class="sd">            If True, a violin plot is visualized. Default is True.</span>
<span class="sd">        x_ticks_rotation : int, optional</span>
<span class="sd">            The rotation angle of the x-axis tick labels for the violin plot. Default is 45</span>
<span class="sd">        summary_stat: str, optional</span>
<span class="sd">            Specifies whether to display the &quot;mean&quot;, &quot;median&quot;, or &quot;both&quot; as reference lines on the plots.</span>
<span class="sd">            This applies when violin_plot is True or when multiple_hist_ax is True for histograms.</span>
<span class="sd">        color : str, optional</span>
<span class="sd">            Color of the violin plot. Default is lightblue.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file. Default is False.</span>
<span class="sd">        ax : Union[None, plt.Axes, np.ndarray, List[plt.Axes]], optional</span>
<span class="sd">            The axes on which to plot. If None, new axes will be created. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[plt.Axes, List[plt.Axes]]</span>
<span class="sd">            Returns a single Axes object or a list of Axes objects containing the plot(s).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method plots the distribution of the radius of gyration (Rg) within each ensemble in the analysis.</span>

<span class="sd">        The Rg values are binned according to the specified number of bins (`bins`) and range (`hist_range`) and </span>
<span class="sd">        displayed as histograms. Additionally, dashed lines representing the mean and median Rg values are overlaid</span>
<span class="sd">        on each histogram.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Calculate features.</span>
        <span class="n">rg_data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rg_data_dict</span><span class="p">()</span>
        <span class="n">hist_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rg_data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rg_data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">n_systems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rg_data_dict</span><span class="p">)</span>

        <span class="c1"># Plot.</span>
        <span class="n">custom_axes</span> <span class="o">=</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">violin_plot</span> <span class="ow">and</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
            <span class="c1"># One axis for each histogram.</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="n">n_systems</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">n_systems</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Only one axis for all histograms.</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_</span><span class="si">{g}</span><span class="s2"> [nm]$&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">violin_plot</span><span class="p">:</span>
            
            <span class="n">plot_violins</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">summary_stat</span><span class="o">=</span><span class="n">summary_stat</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">x_ticks_rotation</span><span class="o">=</span><span class="n">x_ticks_rotation</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
                <span class="n">plot_histogram</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_bins</span> <span class="o">=</span> <span class="n">_get_hist_bins</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span>
                <span class="p">)</span>
                <span class="n">h_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;histtype&quot;</span><span class="p">:</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">hist_data_i</span> <span class="ow">in</span> <span class="n">hist_data</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name_i</span><span class="p">,</span> <span class="n">rg_i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rg_data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># Add a little margin</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">rg_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name_i</span><span class="p">,</span> <span class="o">**</span><span class="n">h_args</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name_i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axis_label</span><span class="p">)</span>
                    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
                        <span class="n">mean_rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rg_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_rg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
                        <span class="n">median_rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">rg_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_rg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">legend_handles</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;rg_comparison_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rg distribution plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/rg_comparison_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_distance_matrix_ens_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">distance_matrix_ens_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">atom_selector</span>
            
            <span class="n">trajectory</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span>
            <span class="n">xyz_ens</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="n">trajectory</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selector</span><span class="p">)]</span>
            <span class="n">distance_matrix_ens_dict</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">xyz_ens</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">distance_matrix_ens_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_contact_ens_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">distance_matrix_ens_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">contact_ens_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">xyz_ens</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">atom_selector</span><span class="p">)]</span>
            <span class="n">distance_matrix_ens_dict</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">xyz_ens</span><span class="p">)</span>
            <span class="n">contact_ens_dict</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_contact_map</span><span class="p">(</span><span class="n">distance_matrix_ens_dict</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">contact_ens_dict</span>
     
<div class="viewcode-block" id="Visualization.end_to_end_distances">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.end_to_end_distances">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">end_to_end_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rg_norm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                         <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
                         <span class="n">hist_range</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                         <span class="n">violin_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">summary_stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                         <span class="n">dpi</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                         <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> 
                         <span class="n">multiple_hist_ax</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">x_ticks_rotation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span>
                         <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot end-to-end distance distributions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rg_norm: bool, optional</span>
<span class="sd">            Normalize end-to-end distances on the average radius of gyration.</span>
<span class="sd">        bins : int, optional</span>
<span class="sd">            The number of bins for the histogram. Default is 50.</span>
<span class="sd">        hist_range: Tuple, optional</span>
<span class="sd">            A tuple with a min and max value for the histogram. Default is None,</span>
<span class="sd">            which corresponds to using the min a max value across all data.</span>
<span class="sd">        violin_plot : bool, optional</span>
<span class="sd">            If True, a violin plot is visualized. Default is True.</span>
<span class="sd">        summary_stat: str, optional</span>
<span class="sd">            Specifies whether to display the &quot;mean&quot;, &quot;median&quot;, or &quot;both&quot; as reference lines on the plots. </span>
<span class="sd">            This applies when violin_plot is True or when multiple_hist_ax is True for histograms.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        ax : Union[None, plt.Axes, np.ndarray, List[plt.Axes]], optional</span>
<span class="sd">            The axes on which to plot. Default is None, which creates a new figure and axes.</span>
<span class="sd">        color: str, optional</span>
<span class="sd">            Change the color of the violin plot. Default is lightblue.</span>
<span class="sd">        multiple_hist_ax: bool, optional</span>
<span class="sd">            If True, it will plot each histogram in a different axis.</span>
<span class="sd">        x_ticks_rotation: int, optional</span>
<span class="sd">            The rotation angle of the x-axis tick labels for the violin plot. Default is 45</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[plt.Axes, List[plt.Axes]]</span>
<span class="sd">            The Axes object or a list of Axes objects containing the plot(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>

        <span class="c1"># Calculate features.</span>
        <span class="n">hist_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_systems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">ca_indices</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">atom_selector</span><span class="p">)</span>
            <span class="n">hist_data_i</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_distances</span><span class="p">(</span>
                <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="p">[[</span><span class="n">ca_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ca_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rg_norm</span><span class="p">:</span>
                <span class="n">rg_i</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_rg</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">hist_data_i</span> <span class="o">=</span> <span class="n">hist_data_i</span> <span class="o">/</span> <span class="n">rg_i</span>
            <span class="n">hist_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

        <span class="c1"># Plot setup depending on plot type and multiple_hist_ax setting</span>
        <span class="n">custom_axes</span> <span class="o">=</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">violin_plot</span> <span class="ow">and</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
            <span class="c1"># Create one axis for each histogram</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="n">n_systems</span><span class="p">,</span> 
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">n_systems</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single axis for all histograms or violin plot</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># Set axis labels and title based on rg_norm</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rg_norm</span><span class="p">:</span>
            <span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_</span><span class="si">{ee}</span><span class="s2"> [nm]$&quot;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$R_</span><span class="si">{ee}</span><span class="s2"> / \langle R_g \rangle$&quot;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Normalized End-to-End Distance ($R_</span><span class="si">{ee}</span><span class="s2"> / \langle R_g \rangle$) Distribution&quot;</span>

        <span class="k">if</span> <span class="n">violin_plot</span><span class="p">:</span>
            <span class="c1"># Plot the violin plot</span>
            <span class="n">plot_violins</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">summary_stat</span><span class="o">=</span><span class="n">summary_stat</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">x_ticks_rotation</span><span class="o">=</span><span class="n">x_ticks_rotation</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
                <span class="c1"># Single histogram plot</span>
                <span class="n">plot_histogram</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Plot separate histograms for each ensemble on separate axes</span>
                <span class="n">_bins</span> <span class="o">=</span> <span class="n">_get_hist_bins</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span>
                <span class="p">)</span>
                <span class="n">h_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;histtype&quot;</span><span class="p">:</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">hist_data_i</span> <span class="ow">in</span> <span class="n">hist_data</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name_i</span><span class="p">,</span> <span class="n">hist_data_i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">hist_data</span><span class="p">)):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name_i</span><span class="p">,</span> <span class="o">**</span><span class="n">h_args</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># Add a little margin</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name_i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axis_label</span><span class="p">)</span>

                    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                        <span class="n">mean_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                        <span class="n">median_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
                        <span class="n">mean_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                        <span class="n">median_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">legend_handles</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;e2e_distances_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;End-to-End distances distribution plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/e2e_distances_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.asphericity">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.asphericity">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">asphericity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                    <span class="n">hist_range</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">violin_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">summary_stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                    <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
                    <span class="n">multiple_hist_ax</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">x_ticks_rotation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span>
                    <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot asphericity distribution in each ensemble.</span>
<span class="sd">        Asphericity is calculated based on the gyration tensor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bins : int, optional</span>
<span class="sd">            The number of bins for the histogram. Default is 50.</span>
<span class="sd">        hist_range: Tuple, optional</span>
<span class="sd">            A tuple with a min and max value for the histogram range. Default is None,</span>
<span class="sd">            which corresponds to using the min a max value across all data.</span>
<span class="sd">        violin_plot : bool, optional</span>
<span class="sd">            If True, a violin plot is visualized. Default is True.</span>
<span class="sd">        summary_stat : str, optional</span>
<span class="sd">            Specifies whether to display the &quot;mean&quot;, &quot;median&quot;, or &quot;both&quot; as reference lines on the plots. </span>
<span class="sd">            This applies when violin_plot is True or when multiple_hist_ax is True for histograms.</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        color : str, optional</span>
<span class="sd">            Color of the violin plot. Default is lightblue.</span>
<span class="sd">        multiple_hist_ax : bool, optional</span>
<span class="sd">            If True, each histogram will be plotted on separate axes. Default is False.</span>
<span class="sd">        x_ticks_rotation : int, optional</span>
<span class="sd">            The rotation angle of the x-axis tick labels for the violin plot. Default is 45</span>
<span class="sd">        ax : Union[None, plt.Axes, np.ndarray, List[plt.Axes]], optional</span>
<span class="sd">            The axes on which to plot. Default is None, which creates a new figure and axes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>

        <span class="c1"># Calculate asphericity for each ensemble</span>
        <span class="n">asph_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">asphericity</span> <span class="o">=</span> <span class="n">compute_asphericity</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">asph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asphericity</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

        <span class="c1"># Plot setup depending on the type of plot and multiple_hist_ax setting</span>
        <span class="n">custom_axes</span> <span class="o">=</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">violin_plot</span> <span class="ow">and</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
            <span class="c1"># Create one axis for each histogram</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">),</span> 
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single axis for all histograms or violin plot</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Asphericity&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">violin_plot</span><span class="p">:</span>
            <span class="c1"># Plot the violin plot</span>
            <span class="n">plot_violins</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">asph_list</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">summary_stat</span><span class="o">=</span><span class="n">summary_stat</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">x_ticks_rotation</span><span class="o">=</span><span class="n">x_ticks_rotation</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
                <span class="c1"># Single histogram plot</span>
                <span class="n">plot_histogram</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">asph_list</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span><span class="p">,</span>
                    
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Plot separate histograms for each ensemble on separate axes</span>
                <span class="n">_bins</span> <span class="o">=</span> <span class="n">_get_hist_bins</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">asph_list</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span>
                <span class="p">)</span>
                <span class="n">h_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;histtype&quot;</span><span class="p">:</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">hist_data_i</span> <span class="ow">in</span> <span class="n">_bins</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name_i</span><span class="p">,</span> <span class="n">asph_data_i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">asph_list</span><span class="p">)):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">asph_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name_i</span><span class="p">,</span> <span class="o">**</span><span class="n">h_args</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># Add a little margin</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name_i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axis_label</span><span class="p">)</span>

                    <span class="c1"># Adding mean/median/both lines with legend</span>
                    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                        <span class="n">mean_asph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">asph_data_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_asph</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                        <span class="n">median_asph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">asph_data_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_asph</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
                        <span class="n">mean_asph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">asph_data_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_asph</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                        <span class="n">median_asph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">asph_data_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_asph</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>

                    <span class="c1"># Add legend if needed</span>
                    <span class="k">if</span> <span class="n">legend_handles</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;asphericity_dist_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Asphericity distribution plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/asphericity_dist_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.prolateness">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.prolateness">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prolateness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">hist_range</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">violin_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">summary_stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
                <span class="n">multiple_hist_ax</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">x_ticks_rotation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span>
                <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot prolateness distribution in each ensemble.</span>
<span class="sd">        Prolateness is calculated based on the gyration tensor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bins : int, optional</span>
<span class="sd">            The number of bins for the histogram. Default is 50.</span>
<span class="sd">        hist_range : Tuple, optional</span>
<span class="sd">            A tuple with a min and max value for the histogram. Default is None,</span>
<span class="sd">            which corresponds to using the min a max value across all data.</span>
<span class="sd">        violin_plot : bool, optional</span>
<span class="sd">            If True, a violin plot is visualized. Default is True.</span>
<span class="sd">        summary_stat : str, optional</span>
<span class="sd">            Specifies whether to display the &quot;mean&quot;, &quot;median&quot;, or &quot;both&quot; as reference lines on the plots.</span>
<span class="sd">            This applies when violin_plot is True or when multiple_hist_ax is True for histograms.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        color : str, optional</span>
<span class="sd">            Color of the violin plot. Default is lightblue.</span>
<span class="sd">        multiple_hist_ax : bool, optional</span>
<span class="sd">            If True, each histogram will be plotted on separate axes. Default is False.</span>
<span class="sd">        x_ticks_rotation : int, optional</span>
<span class="sd">            The rotation angle of the x-axis tick labels for the violin plot. Default is 45</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        ax : Union[None, plt.Axes, np.ndarray, List[plt.Axes]], optional</span>
<span class="sd">            The axes on which to plot. Default is None, which creates a new figure and axes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>

        <span class="c1"># Calculate prolateness for each ensemble</span>
        <span class="n">prolat_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">prolat</span> <span class="o">=</span> <span class="n">compute_prolateness</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">prolat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prolat</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        

        <span class="c1"># Plot setup depending on the type of plot and multiple_hist_ax setting</span>
        <span class="n">custom_axes</span> <span class="o">=</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">violin_plot</span> <span class="ow">and</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
            <span class="c1"># Create one axis for each histogram</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">),</span> 
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">dpi</span><span class="o">=</span> <span class="n">dpi</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single axis for all histograms or violin plot</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">96</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Prolateness&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Prolateness Distribution&quot;</span>

        <span class="k">if</span> <span class="n">violin_plot</span><span class="p">:</span>
            <span class="c1"># Plot the violin plot</span>
            <span class="n">plot_violins</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">prolat_list</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">summary_stat</span><span class="o">=</span><span class="n">summary_stat</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">x_ticks_rotation</span><span class="o">=</span><span class="n">x_ticks_rotation</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">multiple_hist_ax</span><span class="p">:</span>
                <span class="c1"># Single histogram plot</span>
                <span class="n">plot_histogram</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">prolat_list</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="n">axis_label</span><span class="p">,</span>
                    
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Plot separate histograms for each ensemble on separate axes</span>
                <span class="n">_bins</span> <span class="o">=</span> <span class="n">_get_hist_bins</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">prolat_list</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span>
                <span class="p">)</span>
                <span class="n">h_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;histtype&quot;</span><span class="p">:</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">hist_data_i</span> <span class="ow">in</span> <span class="n">_bins</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">hist_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name_i</span><span class="p">,</span> <span class="n">prolat_data_i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">prolat_list</span><span class="p">)):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">prolat_data_i</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">_bins</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name_i</span><span class="p">,</span> <span class="o">**</span><span class="n">h_args</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># Add a little margin</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name_i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axis_label</span><span class="p">)</span>

                    <span class="c1"># Adding mean/median/both lines with legend</span>
                    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                        <span class="n">mean_prolat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prolat_data_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_prolat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                        <span class="n">median_prolat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">prolat_data_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_prolat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary_stat</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
                        <span class="n">mean_prolat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prolat_data_i</span><span class="p">)</span>
                        <span class="n">mean_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_prolat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">mean_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_legend</span><span class="p">)</span>
                        <span class="n">median_prolat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">prolat_data_i</span><span class="p">)</span>
                        <span class="n">median_line</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_prolat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">median_legend</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
                        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_legend</span><span class="p">)</span>

                    <span class="c1"># Add legend if needed</span>
                    <span class="k">if</span> <span class="n">legend_handles</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;prolateness_dist_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Prolateness distribution plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/prolateness_dist_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.alpha_angles">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.alpha_angles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">alpha_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alpha angles: Angles between four consecutive CÎ± atoms along the protein backbone.</span>
<span class="sd">        This method calculates the alpha angles for each ensemble in the analysis and plots their distribution</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bins : int</span>
<span class="sd">            The number of bins for the histogram. Default is 50.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file. Default is False.</span>
<span class="sd">        ax : plt.Axes, optional</span>
<span class="sd">            The axes on which to plot. Default is None, which creates a new figure and axes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">data_i</span> <span class="o">=</span> <span class="n">featurize_a_angle</span><span class="p">(</span>
                <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span>
                <span class="n">get_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">atom_selector</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">atom_selector</span>
            <span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_i</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

        <span class="n">plot_histogram</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
            <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Distribution of Alpha Angles&quot;</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Angle [rad]&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;alpha_dist_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.contact_prob_maps">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.contact_prob_maps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contact_prob_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">log_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">avoid_zero_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span> 
            <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the contact probability map based on the threshold.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        log_scale : bool, optional</span>
<span class="sd">            If True, use log scale range. Default is True.</span>
<span class="sd">        avoid_zero_count: bool, optional</span>
<span class="sd">            If True, avoid contacts with zero counts by adding to all contacts a pseudo count of 1e-6.</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            Determining the threshold for calculating the contact frequencies. Default is 0.8 [nm].</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        color : str, optional</span>
<span class="sd">            The colormap to use for the contact probability map. Default is &#39;Blues&#39;.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">             If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        ax : Union[None, List[plt.Axes], np.ndarray], optional</span>
<span class="sd">            The axes on which to plot. If None, new axes will be created. Default is None.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[List[plt.Axes], np.ndarray]</span>
<span class="sd">            Returns a list or array of Axes objects representing the subplot grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">num_proteins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">)</span>
        <span class="n">num_cols</span> <span class="o">=</span> <span class="n">num_proteins</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">num_cols</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ax_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">ax_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ensembles</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="n">matrix_p_map</span> <span class="o">=</span> <span class="n">contact_probability_map</span><span class="p">(</span>
                <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span>
                <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;ca&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">coarse_grained</span> <span class="k">else</span> <span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">avoid_zero_count</span><span class="p">:</span>
                <span class="n">matrix_p_map</span> <span class="o">+=</span> <span class="mf">1e-6</span>

            <span class="k">if</span> <span class="n">log_scale</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">matrix_p_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                               <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">matrix_p_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Contact frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;contact_prob_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Contact probability map saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/contact_prob_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">axes</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_pair_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">max_sep</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>
        <span class="n">pair_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">:</span>
            <span class="n">ca_ids</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
            <span class="n">max_sep</span> <span class="o">=</span> <span class="n">get_max_sep</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span> <span class="n">max_sep</span><span class="o">=</span><span class="n">max_sep</span><span class="p">)</span>
    <span class="c1"># Get all pair of ids.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">id_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ca_ids</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">id_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ca_ids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">-</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">min_sep</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">-</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_sep</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">pair_ids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">id_i</span><span class="p">,</span> <span class="n">id_j</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pair_ids</span>
    
<div class="viewcode-block" id="Visualization.ramachandran_plots">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.ramachandran_plots">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ramachandran_plots</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">two_d_hist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">bins</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
        <span class="n">log_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ramachandran plot. If two_d_hist=True it returns a 2D histogram </span>
<span class="sd">        for each ensemble. If two_d_hist=False it returns a simple scatter plot </span>
<span class="sd">        for all ensembles in one plot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        two_d_hist : bool, optional</span>
<span class="sd">            If True, it returns a 2D histogram for each ensemble. Default is True.</span>
<span class="sd">        bins : tuple, optional</span>
<span class="sd">            You can customize the bins for 2D histogram. Default is (-180, 180, 80).</span>
<span class="sd">        log_scale : bool, optional</span>
<span class="sd">            If True, the histogram will be plotted on a logarithmic scale. Default is True.</span>
<span class="sd">        color : str, optional   </span>
<span class="sd">            The colormap to use for the 2D histogram. Default is &#39;viridis&#39;.</span>
<span class="sd">        dpi : int, optional </span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>
<span class="sd">        ax : Union[None, plt.Axes, np.ndarray, List[plt.Axes]], optional</span>
<span class="sd">            The axes on which to plot. If None, new axes will be created. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[List[plt.Axes], plt.Axes]</span>
<span class="sd">            If two_d_hist=True, returns a list of Axes objects representing the subplot grid for each ensemble. </span>
<span class="sd">            If two_d_hist=False, returns a single Axes object representing the scatter plot for all ensembles.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">exists_coarse_grained</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This analysis is not possible with coarse-grained models.&quot;</span><span class="p">)</span>

        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="k">if</span> <span class="n">two_d_hist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough axes provided: expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">)</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="n">rama_linspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">ax_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ensembles</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
                <span class="n">phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_phi</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)[</span><span class="mi">1</span><span class="p">])[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">psi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)[</span><span class="mi">1</span><span class="p">])[:,</span> <span class="mi">1</span><span class="p">:]</span>

                <span class="n">hist2d</span> <span class="o">=</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span>
                    <span class="n">phi_angles</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">psi_angles</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">rama_linspace</span><span class="p">,</span> <span class="n">rama_linspace</span><span class="p">),</span>
                    <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span> <span class="k">if</span> <span class="n">log_scale</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">density</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="n">ax_i</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">ax_i</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\phi$ (Â°)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">ax_i</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\psi$ (Â°)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">ax_i</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

                <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">hist2d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_i</span><span class="p">)</span>
                <span class="n">colorbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
            <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
                <span class="n">phi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_phi</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">psi_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_psi</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">phi_angles</span><span class="p">,</span> <span class="n">psi_angles</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Phi (Ï•) Angle (degrees)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Psi (Ïˆ) Angle (degrees)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ramachandran Plot&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;ramachandran_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ramachandran plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/ramachandran_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.site_specific_flexibility">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.site_specific_flexibility">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">site_specific_flexibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                        <span class="n">pointer</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                        <span class="n">auto_xticks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">xtick_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> 
                        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a plot of the site-specific flexibility parameter.</span>
<span class="sd">        </span>
<span class="sd">        This plot shows the site-specific measure of disorder, which is sensitive to local flexibility based on </span>
<span class="sd">        the circular variance of the Ramachandran angles Ï† and Ïˆ for each residue in the ensemble.</span>
<span class="sd">        The score ranges from 0 for identical dihedral angles for all conformers at the residue i to 1 for a </span>
<span class="sd">        uniform distribution of dihedral angles at the residue i. (For more information about this method look at here https://onlinelibrary.wiley.com/doi/full/10.1002/pro.4906)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pointer: List[int], optional</span>
<span class="sd">            A list of desired residues. Vertical dashed lines will be added to point to these residues. Default is None.</span>
<span class="sd">        auto_xticks: bool, optional</span>
<span class="sd">            If True, use matplotlib default xticks.</span>
<span class="sd">        xtick_interval: int, optional</span>
<span class="sd">            If `auto_xticks` is False, this parameter defines the interval between displayed residue indices on the x-axis.</span>
<span class="sd">            Always start with 1, followed by every `xtick_interval` residues (e.g., 1, 5, 10, 15, ... if `xtick_interval`=5).</span>
<span class="sd">        figsize: Tuple[int, int], optional</span>
<span class="sd">            The size of the figure. Default is (15, 5).</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file. Default is False.</span>
<span class="sd">        ax : Union[None, plt.Axes], optional</span>
<span class="sd">            The matplotlib Axes object on which to plot. If None, a new Axes object will be created. Default is None.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The matplotlib Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">exists_coarse_grained</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This analysis is not possible with coarse-grained models.&quot;</span><span class="p">)</span>
        
        <span class="n">features_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">get_features</span><span class="p">(</span><span class="n">featurization</span><span class="o">=</span><span class="s1">&#39;phi_psi&#39;</span><span class="p">)</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="n">ss_measure_disorder</span><span class="p">(</span><span class="n">features_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_xticks</span><span class="p">:</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">next_tick</span> <span class="o">=</span> <span class="n">xtick_interval</span>
            <span class="k">while</span> <span class="n">next_tick</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_tick</span><span class="p">)</span>
                <span class="n">next_tick</span> <span class="o">+=</span> <span class="n">xtick_interval</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="c1"># ax.set_title(&quot;Site-specific Flexibility parameter plot&quot;, fontsize=22, weight=&#39;bold&#39;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Residue Index&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Site-specific Flexibility parameter&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># ax.legend(fontsize=12)</span>

        <span class="k">if</span> <span class="n">pointer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">pointer</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;ss_flexibility_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>  
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Site-specific flexibility plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/ss_flexibility_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.site_specific_order">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.site_specific_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">site_specific_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                        <span class="n">pointer</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  
                        <span class="n">auto_xticks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">xtick_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                        <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a plot of the site-specific order parameter.</span>
<span class="sd">        The function computes and plots per-residue order parameters that quantify how consistently each residue&#39;s backbone orientation </span>
<span class="sd">        is aligned with the rest of the chain across all conformers in an ensemble.</span>
<span class="sd">        The result is a per-residue value between 0 and 1: values near 1 indicate high orientational order (rigid or structured regions), </span>
<span class="sd">        while values near 0 reflect disorder (flexible or unstructured regions). This measure captures long-range orientational correlations</span>
<span class="sd">        in the backbone and is particularly useful for detecting weakly ordered segments in intrinsically disordered proteins.</span>
<span class="sd">        (For more information about this method look at here https://onlinelibrary.wiley.com/doi/full/10.1002/pro.4906)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pointer: List[int], optional</span>
<span class="sd">            A list of desired residues. Vertical dashed lines will be added to point to these residues. Default is None.</span>
<span class="sd">        auto_xticks: bool, optional</span>
<span class="sd">            If True, use matplotlib default xticks.</span>
<span class="sd">        xtick_interval: int, optional</span>
<span class="sd">            If `auto_xticks` is False, this parameter defines the interval between displayed residue indices on the x-axis.</span>
<span class="sd">            Always start with 1, followed by every `xtick_interval` residues (e.g., 1, 5, 10, 15, ... if `xtick_interval`=5).</span>
<span class="sd">        figsize: Tuple[int, int], optional</span>
<span class="sd">            The size of the figure. Default is (15, 5).</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file. Default is False.</span>
<span class="sd">        ax : Union[None, plt.Axes], optional</span>
<span class="sd">            The matplotlib Axes object on which to plot. If None, a new Axes object will be created. Default is None.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The matplotlib Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">dict_ca_xyz</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">ca_index</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">atom_selector</span><span class="p">)</span>
            <span class="n">dict_ca_xyz</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span> <span class="n">ca_index</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">dict_order_parameter</span> <span class="o">=</span> <span class="n">site_specific_order_parameter</span><span class="p">(</span><span class="n">dict_ca_xyz</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">dict_order_parameter</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_xticks</span><span class="p">:</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">next_tick</span> <span class="o">=</span> <span class="n">xtick_interval</span>
            <span class="k">while</span> <span class="n">next_tick</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_tick</span><span class="p">)</span>
                <span class="n">next_tick</span> <span class="o">+=</span> <span class="n">xtick_interval</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Site-specific Order Parameter&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Residue Index&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Order parameter&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">pointer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">pointer</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;ss_order_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>  
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Site-specific order parameter plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/ss_order_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.per_residue_mean_sasa">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.per_residue_mean_sasa">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">per_residue_mean_sasa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">probe_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.14</span><span class="p">,</span>
                            <span class="n">n_sphere_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">960</span><span class="p">,</span> 
                            <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
                            <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                            <span class="n">auto_xticks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">xtick_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                            <span class="n">pointer</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the average solvent-accessible surface area (SASA) for each residue among all conformations in an ensemble.</span>
<span class="sd">        This function uses the Shrakeâ€“Rupley algorithm as implemented in MDTraj (`mdtraj.shrake_rupley`) to compute</span>
<span class="sd">        the solvent-accessible surface area.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        probe_radius: float, optional</span>
<span class="sd">            The radius of the probe sphere used in the Shrakeâ€“Rupley algorithm. Default is 0.14 nm.</span>
<span class="sd">        n_sphere_points: int, optional</span>
<span class="sd">            The number of points representing the surface of each atom, higher values leads to more accuracy. Default is 960.</span>
<span class="sd">        figsize: Tuple[int, int], optional</span>
<span class="sd">            Tuple specifying the size of the figure. Default is (15, 5).</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        size: int, optional</span>
<span class="sd">            The size of the marker points. Default is 3.</span>
<span class="sd">        auto_xticks: bool, optional</span>
<span class="sd">            If True, use matplotlib default xticks. Default is True.</span>
<span class="sd">        xtick_interval: int, optional</span>
<span class="sd">            If `auto_xticks` is False, this parameter defines the interval between displayed residue indices</span>
<span class="sd">            on the x-axis. Always start with 1, followed by every `xtick_interval` residues (e.g., 1, 5, 10, 15, ... if `xtick_interval`=5).</span>
<span class="sd">        pointer: List[int], optional</span>
<span class="sd">            List of desired residues to highlight with vertical dashed lines. Default is None.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file. Default is False.</span>
<span class="sd">        ax : Union[None, plt.Axes], optional</span>
<span class="sd">            The matplotlib Axes object on which to plot. If None, a new Axes object will be created. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            Axes object containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># Get the color cycle from matplotlib</span>
        <span class="n">prop_cycle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">prop_cycle</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
            <span class="n">res_based_sasa</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">shrake_rupley</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;residue&#39;</span><span class="p">,</span> <span class="n">probe_radius</span><span class="o">=</span><span class="n">probe_radius</span><span class="p">,</span>
                                                  <span class="n">n_sphere_points</span><span class="o">=</span><span class="n">n_sphere_points</span><span class="p">)</span>
            <span class="n">sasa_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res_based_sasa</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sasa_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">res_based_sasa</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>        

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sasa_mean</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">sasa_mean</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ens</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="c1"># ax.fill_between(np.arange(1, len(sasa_mean) + 1), sasa_mean - sasa_std, sasa_mean + sasa_std, alpha=0.3, color=colors[i % len(colors)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sasa_mean</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">sasa_mean</span> <span class="o">+</span> <span class="n">sasa_std</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ens</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s1"> (mean Â± SD)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sasa_mean</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">sasa_mean</span> <span class="o">-</span> <span class="n">sasa_std</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c1"># Set x-ticks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_xticks</span><span class="p">:</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">next_tick</span> <span class="o">=</span> <span class="n">xtick_interval</span>
            <span class="k">while</span> <span class="n">next_tick</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sasa_mean</span><span class="p">):</span>
                <span class="n">ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_tick</span><span class="p">)</span>
                <span class="n">next_tick</span> <span class="o">+=</span> <span class="n">xtick_interval</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residue Index&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mean SASA [nmÂ²]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mean SASA for Each Residue in Ensembles&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># ax.grid(True)</span>
        
        <span class="k">if</span> <span class="n">pointer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">pointer</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;local_sasa_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>  
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Local SASA plot saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/local_sasa_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.distance_maps">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.distance_maps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">distance_maps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">min_sep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
        <span class="n">max_sep</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">distance_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
        <span class="n">get_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
        <span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span>  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;plasma&quot;</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot CA and/or COM distance maps for one or more protein ensembles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        min_sep : int, default=2</span>
<span class="sd">            Minimum sequence separation between residues to consider.</span>
<span class="sd">        max_sep : int or None, optional</span>
<span class="sd">            Maximum sequence separation. If None, no upper limit is applied.</span>
<span class="sd">        distance_type : {&#39;ca&#39;, &#39;com&#39;, &#39;both&#39;}, default=&#39;both&#39;</span>
<span class="sd">            Specifies which type of distance map(s) to plot.</span>
<span class="sd">        get_names : bool, default=True</span>
<span class="sd">            Whether to return feature names from featurization (used internally).</span>
<span class="sd">        inverse : bool, default=False</span>
<span class="sd">            If True, compute and plot 1/distance instead of distance.</span>
<span class="sd">        color : str, default=&#39;plasma&#39;</span>
<span class="sd">            Colormap to use for the distance maps.</span>
<span class="sd">        dpi : int, default=96</span>
<span class="sd">            The DPI (dots per inch) of the output figure.</span>
<span class="sd">        save : bool, default=False</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory.</span>
<span class="sd">        ax : matplotlib Axes or array-like, optional</span>
<span class="sd">            Axes on which to plot. If None, a new figure and axes will be created.</span>
<span class="sd">       </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[matplotlib.axes.Axes]</span>
<span class="sd">            List of axes objects used for plotting.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">distance_type</span> <span class="o">=</span> <span class="n">distance_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">distance_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;com&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">exists_coarse_grained</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This analysis is not possible with coarse-grained models.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">distance_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;com&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`distance_type` must be one of {&#39;CA&#39;, &#39;COM&#39;, &#39;both&#39;}&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">distance_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;com&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`distance_type` must be one of {&#39;CA&#39;, &#39;COM&#39;, &#39;both&#39;}&quot;</span><span class="p">)</span>

        <span class="n">num_proteins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)</span>

        <span class="c1"># ---- layout -------------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">distance_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_proteins</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_proteins</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">),</span>
                <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
                <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span>   <span class="c1"># &lt;--- ensures 2D array</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">custom_axes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_proteins</span> <span class="k">if</span> <span class="n">distance_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span> <span class="k">else</span> <span class="n">num_proteins</span>
            <span class="k">if</span> <span class="n">axes</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`ax` must contain </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2"> axes for show=&#39;</span><span class="si">{</span><span class="n">distance_type</span><span class="si">}</span><span class="s2">&#39; and </span><span class="si">{</span><span class="n">num_proteins</span><span class="si">}</span><span class="s2"> proteins.&quot;</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>
        <span class="c1"># ------------------------------------------------------------------------</span>

        <span class="n">plotted_axes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">set_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;j&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">maybe_inverse</span><span class="p">(</span><span class="n">dmap</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">apply</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">apply</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dmap</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dmap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dmap</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">inv</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">trajectory</span>
            <span class="n">feat</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">featurize_com_dist</span><span class="p">(</span>
                <span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="n">min_sep</span><span class="p">,</span> <span class="n">max_sep</span><span class="o">=</span><span class="n">max_sep</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="n">inverse</span><span class="p">,</span> <span class="n">get_names</span><span class="o">=</span><span class="n">get_names</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# Ensemble: </span><span class="si">{</span><span class="n">ens</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;features: </span><span class="si">{</span><span class="n">feat</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">distance_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">}:</span>
                <span class="n">ca_dmap</span> <span class="o">=</span> <span class="n">calc_ca_dmap</span><span class="p">(</span><span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="n">min_sep</span><span class="p">,</span> <span class="n">max_sep</span><span class="o">=</span><span class="n">max_sep</span><span class="p">)</span>
                <span class="n">ca_dmap_mean</span> <span class="o">=</span> <span class="n">maybe_inverse</span><span class="p">(</span><span class="n">ca_dmap</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">inverse</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># always the first row</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">ax_ca</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">im0</span> <span class="o">=</span> <span class="n">ax_ca</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ca_dmap_mean</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">ax_ca</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ens</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> CA&quot;</span><span class="p">)</span>
                <span class="n">set_labels</span><span class="p">(</span><span class="n">ax_ca</span><span class="p">)</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_ca</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;1 / distance [1/nm]&quot;</span> <span class="k">if</span> <span class="n">inverse</span> <span class="k">else</span> <span class="s2">&quot;distance [nm]&quot;</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">plotted_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax_ca</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">distance_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;com&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">}:</span>
                <span class="n">com_dmap</span> <span class="o">=</span> <span class="n">calc_com_dmap</span><span class="p">(</span><span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="n">min_sep</span><span class="p">,</span> <span class="n">max_sep</span><span class="o">=</span><span class="n">max_sep</span><span class="p">)</span>
                <span class="n">com_dmap_mean</span> <span class="o">=</span> <span class="n">maybe_inverse</span><span class="p">(</span><span class="n">com_dmap</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">inverse</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">distance_type</span> <span class="o">!=</span> <span class="s2">&quot;both&quot;</span> <span class="k">else</span> <span class="mi">1</span>  <span class="c1"># second row only when &#39;both&#39;</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">ax_com</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">im1</span> <span class="o">=</span> <span class="n">ax_com</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">com_dmap_mean</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">ax_com</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ens</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> COM&quot;</span><span class="p">)</span>
                <span class="n">set_labels</span><span class="p">(</span><span class="n">ax_com</span><span class="p">)</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_com</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;1 / distance [1/nm]&quot;</span> <span class="k">if</span> <span class="n">inverse</span> <span class="k">else</span> <span class="s2">&quot;distance [nm]&quot;</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">plotted_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax_com</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_axes</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="c1"># Save once (whole panel) or one file per protein; here I keep the whole panel.</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;dist_</span><span class="si">{</span><span class="n">distance_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Distance maps saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plotted_axes</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_grid_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">ens_lens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">get_num_residues</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ens_lens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># May remove the limit in the future.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot build an histogram grid with proteins of different lengths&quot;</span>
            <span class="p">)</span>
        <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ens_lens</span><span class="p">)</span>  <span class="c1"># Get the minimum number of residues.</span>
        <span class="k">return</span> <span class="n">min_len</span>

<div class="viewcode-block" id="Visualization.plot_histogram_grid">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.plot_histogram_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_histogram_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ca_dist&quot;</span><span class="p">,</span>
            <span class="n">ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">n_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">n_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">subplot_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">subplot_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span>
            <span class="n">bins</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a grid if histograms for distance or angular features. Can only be</span>
<span class="sd">        used when analyzing ensembles of proteins with same number of</span>
<span class="sd">        residues. The function will create a new matplotlib figure for histogram</span>
<span class="sd">        grid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        feature: str, optional</span>
<span class="sd">            Feature to analyze. Must be one of `ca_dist` (Ca-Ca distances),</span>
<span class="sd">            `a_angle` (alpha angles), `phi` or `psi` (phi or psi backbone</span>
<span class="sd">            angles).</span>
<span class="sd">        ids: Union[list, List[list]], optional</span>
<span class="sd">            Residue indices (integers starting from zero) to define the residues</span>
<span class="sd">            to analyze. For angular features it must be a 1d list with N indices</span>
<span class="sd">            of the residues. For distance features it must be 2d list/array of</span>
<span class="sd">            shape (N, 2) in which N is the number of residue pairs to analyze</span>
<span class="sd">            are 2 their indices. Each of the N indices (or pair of indices) will</span>
<span class="sd">            be plotted in an histogram of the grid. If this argument is not</span>
<span class="sd">            provided, random indices will be sampled, which is useful for</span>
<span class="sd">            quickly comparing the distance or angle distributions of multiple</span>
<span class="sd">            ensembles.</span>
<span class="sd">        n_rows: int, optional</span>
<span class="sd">            Number of rows in the histogram grid.</span>
<span class="sd">        n_cols: int, optional</span>
<span class="sd">            Number of columns in the histogram grid.</span>
<span class="sd">        subplot_width: int, optional</span>
<span class="sd">            Use to specify the Matplotlib width of the figure. The size of the</span>
<span class="sd">            figure will be calculated as: figsize = (n_cols*subplot_width, n_rows*subplot_height).</span>
<span class="sd">        subplot_height: int, optional</span>
<span class="sd">            See the subplot_width argument.</span>
<span class="sd">        bins: Union[str, int], optional</span>
<span class="sd">            Number of bins in all the histograms.</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save: bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax: plt.Axes</span>
<span class="sd">            The Axes object for the histogram grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">### Check the ensembles.</span>
        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">min_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_grid_input</span><span class="p">()</span>
        
        <span class="c1">### Select the features to analyze.</span>
        <span class="n">n_hist</span> <span class="o">=</span> <span class="n">n_rows</span><span class="o">*</span><span class="n">n_cols</span>
        <span class="k">if</span> <span class="n">_get_max_plots_in_grid</span><span class="p">(</span><span class="n">min_len</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_hist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough residues to plot </span><span class="si">{</span><span class="n">n_hist</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> histograms&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_hist</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The number of provided ids (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="s2">) is incompatible with&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; the number of histograms (</span><span class="si">{</span><span class="n">n_hist</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;ca_dist&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">_to_array</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Invalid shape for residue ids for Ca-Ca distances, received&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2"> expected (</span><span class="si">{</span><span class="n">n_hist</span><span class="si">}</span><span class="s2">, 2)&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">min_len</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Maximum residue idx (</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="s2">) exceeds the number of&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; residues (</span><span class="si">{</span><span class="n">min_len</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">_get_random_pairs</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_hist</span><span class="p">,</span> <span class="n">prot_len</span><span class="o">=</span><span class="n">min_len</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;a_angle&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">_get_a_angle_ids</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Invalid shape for residue ids for a angles, received&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2"> expected (</span><span class="si">{</span><span class="n">n_hist</span><span class="si">}</span><span class="s2">, )&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">min_len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Maximum residue idx (</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="s2">) exceeds the number of&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; plottable alpha torsion angles (</span><span class="si">{</span><span class="n">min_len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">_get_random_a_angle_ids</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_hist</span><span class="p">,</span> <span class="n">prot_len</span><span class="o">=</span><span class="n">min_len</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;psi&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">coarse_grained</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot analyze </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> angles when a coarse-grained&quot;</span>
                    <span class="s2">&quot; ensemble is loaded.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">_to_array</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid shape for residue ids for </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> angles, received&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2"> expected (*, )&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rand_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_len</span> <span class="o">-</span> <span class="n">_phi_psi_offsets</span><span class="p">[</span><span class="n">feature</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Maximum residue idx (</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">rand_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">) exceeds the number of&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; plottable </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> angles for proteins with </span><span class="si">{</span><span class="n">min_len</span><span class="si">}</span><span class="s2"> residues&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;phi&quot;</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">rand_ids</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot use residue idx 0 with phi angles&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">min_len</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_hist</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">_phi_psi_offsets</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rand_ids</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can only use residue indices &gt;= 0&quot;</span><span class="p">)</span>

        <span class="c1">### Calculate features.</span>
        <span class="n">hist_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">ca_indices</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">atom_selector</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;ca_dist&quot;</span><span class="p">:</span>
                <span class="n">data_k</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_distances</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">ca_indices</span><span class="p">[</span><span class="n">rand_ids</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;a_angle&quot;</span><span class="p">:</span>
                <span class="n">data_k</span> <span class="o">=</span> <span class="n">mdtraj</span><span class="o">.</span><span class="n">compute_dihedrals</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">ca_indices</span><span class="p">[</span><span class="n">rand_ids</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;psi&quot;</span><span class="p">):</span>
                <span class="n">data_k</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mdtraj</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;compute_</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">data_k</span> <span class="o">=</span> <span class="n">data_k</span><span class="p">[:,</span><span class="n">rand_ids</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">_phi_psi_offsets</span><span class="p">[</span><span class="n">feature</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="n">hist_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_k</span><span class="p">)</span>
        
        <span class="c1">### Initialize the plot.</span>
        <span class="c1"># Initialize the figure.</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_cols</span><span class="o">*</span><span class="n">subplot_width</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">*</span><span class="n">subplot_height</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Initialize the subplots.</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Figure elements.</span>
        <span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;ca_dist&quot;</span><span class="p">:</span>
            <span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Distance [nm]&quot;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C$\alpha$-C$\alpha$ distances&quot;</span>
        <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;a_angle&quot;</span><span class="p">:</span>
            <span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Angle [rad]&quot;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$\alpha$ angles&quot;</span>
        <span class="k">elif</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;psi&quot;</span><span class="p">):</span>
            <span class="n">axis_label</span> <span class="o">=</span> <span class="s2">&quot;Angle [rad]&quot;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;$\</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">$ angles&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        
        <span class="c1">### Plot the histograms.</span>
        <span class="n">row_c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">col_c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hist_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;histtype&quot;</span><span class="p">:</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_hist</span><span class="p">):</span>
            
            <span class="c1"># Define variables to build the histograms.</span>
            <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ca_dist&quot;</span><span class="p">,</span> <span class="p">):</span>
                <span class="n">_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="p">[:,</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hist_data</span><span class="p">])</span>
                <span class="n">_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="p">[:,</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hist_data</span><span class="p">])</span>
                <span class="n">idx_i</span><span class="p">,</span> <span class="n">idx_j</span> <span class="o">=</span> <span class="n">rand_ids</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;C$\alpha$ </span><span class="si">{</span><span class="n">idx_i</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idx_j</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a_angle&quot;</span><span class="p">,</span> <span class="p">):</span>
                <span class="n">_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">idx_i</span><span class="p">,</span> <span class="n">idx_j</span><span class="p">,</span> <span class="n">idx_k</span><span class="p">,</span> <span class="n">idx_l</span> <span class="o">=</span> <span class="n">rand_ids</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;C$\alpha$ </span><span class="si">{</span><span class="n">idx_i</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idx_j</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idx_k</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idx_l</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;psi&quot;</span><span class="p">):</span>
                <span class="n">_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">rand_ids</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                
            <span class="c1"># Histogram.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">)):</span>
                <span class="n">data_km</span> <span class="o">=</span> <span class="n">hist_data</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
                    <span class="n">data_km</span><span class="p">,</span>
                    <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">_min</span><span class="p">,</span> <span class="n">_max</span><span class="p">),</span>
                    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">ensembles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="k">if</span> <span class="p">(</span><span class="n">row_c</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">hist_args</span>
                <span class="p">)</span>
                
            <span class="c1"># Labels and titles.</span>
            <span class="n">default_font_size</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">default_font_size</span><span class="p">)</span>
            <span class="c1"># ax[row_c][col_c].text(0.95, 0.95, text, verticalalignment=&#39;top&#39;,</span>
            <span class="c1">#                       horizontalalignment=&#39;right&#39;,</span>
            <span class="c1">#                       transform=ax[row_c][col_c].transAxes, fontsize=8,</span>
            <span class="c1">#                       color=&#39;black&#39;, alpha=0.8)</span>

            <span class="k">if</span> <span class="n">col_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row_c</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">n_rows</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axis_label</span><span class="p">)</span>
                
            <span class="c1"># Increase row and column counters.</span>
            <span class="n">col_c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">col_c</span> <span class="o">==</span> <span class="n">n_cols</span><span class="p">:</span>
                <span class="n">row_c</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">col_c</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Legend.</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;hist_grid_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Saved histogram grid to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/hist_grid_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.plot_rama_grid">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.plot_rama_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_rama_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">n_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">n_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">subplot_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">subplot_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> 
            <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a grid if Ramachandran plots for different residues. Can only be</span>
<span class="sd">        be used when analyzing ensembles of proteins with same number of</span>
<span class="sd">        residues. The function will create a new matplotlib figure for the</span>
<span class="sd">        scatter plot grid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ids: Union[list, List[list]], optional</span>
<span class="sd">            Residue indices (integers starting from zero) to define the residues</span>
<span class="sd">            to analyze. For angular features it must be a 1d list with N indices</span>
<span class="sd">            of the residues. Each of the N indices will be plotted in an scatter</span>
<span class="sd">            plot in the grid. If this argument is not provided, random indices</span>
<span class="sd">            will be sampled, which is useful for quickly comparing features of</span>
<span class="sd">            multiple ensembles.</span>
<span class="sd">        n_rows: int, optional</span>
<span class="sd">            Number of rows in the scatter grid.</span>
<span class="sd">        n_cols: int, optional</span>
<span class="sd">            Number of columns in the scatter grid.</span>
<span class="sd">        subplot_width: int, optional</span>
<span class="sd">            Use to specify the Matplotlib width of the figure. The size of the</span>
<span class="sd">            figure will be calculated as: figsize = (n_cols*subplot_width, n_rows*subplot_height).</span>
<span class="sd">        subplot_height: int, optional</span>
<span class="sd">            See the subplot_width argument.</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            The DPI (dots per inch) of the output figure. Default is 96.</span>
<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, the plot will be saved as an image file in the specified directory. Default is False.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax: plt.Axes</span>
<span class="sd">            The Axes object for the scatter plot grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">### Check the ensembles.</span>
        <span class="n">ensembles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="n">min_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_grid_input</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">exists_coarse_grained</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This analysis is not possible with coarse-grained models.&quot;</span><span class="p">)</span>
        
        <span class="c1">### Select the features to analyze.</span>
        <span class="n">n_plots</span> <span class="o">=</span> <span class="n">n_rows</span><span class="o">*</span><span class="n">n_cols</span>
        <span class="k">if</span> <span class="n">_get_max_plots_in_grid</span><span class="p">(</span><span class="n">min_len</span><span class="p">,</span> <span class="s2">&quot;rama&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_plots</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Not enough residues to make </span><span class="si">{</span><span class="n">n_plots</span><span class="si">}</span><span class="s2"> Ramachandran plots&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_plots</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The number of provided ids (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="s2">) is incompatible with&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; the number of scatter plots (</span><span class="si">{</span><span class="n">n_plots</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">coarse_grained</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot analyze rama angles when a coarse-grained&quot;</span>
                <span class="s2">&quot; ensemble is loaded.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">_to_array</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid shape for residue ids for Ramachandran plots,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; received </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">rand_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2"> expected (*, )&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rand_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Maximum residue idx (</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">rand_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">) exceeds the number of&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; plottable rama angles for proteins with </span><span class="si">{</span><span class="n">min_len</span><span class="si">}</span><span class="s2"> residues&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">rand_ids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot use residue idx 0 with phi angles&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rand_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">min_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rand_ids</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can only use residue indices &gt;= 0&quot;</span><span class="p">)</span>

        <span class="c1">### Calculate features.</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ensemble</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="c1"># We end up with L-2 Ramachandran plots. We slice on axis=1</span>
            <span class="c1"># to pair phi and psi angles of the same residues.</span>
            <span class="n">data_k</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_features</span><span class="p">(</span><span class="s2">&quot;phi_psi&quot;</span><span class="p">,</span> <span class="n">ravel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Here we use -1 because phi-psi pairs start from the second</span>
            <span class="c1"># residue.</span>
            <span class="n">data_k</span> <span class="o">=</span> <span class="n">data_k</span><span class="p">[:,</span><span class="n">rand_ids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,:]</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_k</span><span class="p">)</span>
        
        <span class="c1">### Initialize the plot.</span>
        <span class="c1"># Initialize the figure.</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_cols</span><span class="o">*</span><span class="n">subplot_width</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">*</span><span class="n">subplot_height</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Initialize the subplots.</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Figure elements.</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;phi [rad]&quot;</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;psi [rad]&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ramachandran plots&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        
        <span class="c1">### Plot the histograms.</span>
        <span class="n">row_c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">col_c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># hist_args = {&quot;histtype&quot;: &quot;step&quot;, &quot;density&quot;: True}</span>
        <span class="n">hist_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plots</span><span class="p">):</span>
            
            <span class="c1"># Define variables to build the histograms.</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">rand_ids</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                
            <span class="c1"># Histogram.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">)):</span>
                <span class="n">data_km</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">data_km</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">data_km</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">ensembles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="k">if</span> <span class="p">(</span><span class="n">row_c</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">hist_args</span>
                <span class="p">)</span>
                
            <span class="c1"># Labels and titles.</span>
            <span class="n">default_font_size</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">default_font_size</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">col_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row_c</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">n_rows</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row_c</span><span class="p">][</span><span class="n">col_c</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
                
            <span class="c1"># Increase row and column counters.</span>
            <span class="n">col_c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">col_c</span> <span class="o">==</span> <span class="n">n_cols</span><span class="p">:</span>
                <span class="n">row_c</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">col_c</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Legend.</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="p">,</span> <span class="s1">&#39;rama_grid_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Saved Ramachandran grid to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dir</span><span class="si">}</span><span class="s2">/rama_grid_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ens_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Visualization.comparison_matrix">
<a class="viewcode-back" href="../../visualization.html#idpet.visualization.Visualization.comparison_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">comparison_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">score</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">featurization_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="n">bootstrap_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bootstrap_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">bootstrap_replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="n">significance_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="n">bins</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">ax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">6.00</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
            <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis_r&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">cbar_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">textcolors</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates and visualizes the pairwise comparison matrix for the ensembles.</span>
<span class="sd">        This function computes the comparison matrix using the specified score</span>
<span class="sd">        type and feature. It then visualizes the matrix using a heatmap.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        score, featurization_params, bootstrap_iters, bootstrap_frac,</span>
<span class="sd">        bootstrap_replace, bins, random_seed, verbose:</span>
<span class="sd">            See the documentation of `EnsembleAnalysis.comparison_scores` for</span>
<span class="sd">            more information about these arguments.</span>
<span class="sd">        ax: Union[None, plt.Axes], optional</span>
<span class="sd">            Axes object where to plot the comparison heatmap. If `None` (the</span>
<span class="sd">            default value) is provided, a new Figure will be created.</span>
<span class="sd">        figsize: Tuple[int], optional</span>
<span class="sd">            The size of the figure for the heatmap. Default is (6.00, 5.0). Only</span>
<span class="sd">            takes effect if `ax` is not `None`.</span>
<span class="sd">        dpi: int, optional</span>
<span class="sd">            DPIs of the figure for the heatmap. Default is 100. Only takes</span>
<span class="sd">            effect if `ax` is not `None`.</span>
<span class="sd">        confidence_level, significance_level, cmap, title, cbar_label,</span>
<span class="sd">        textcolors:</span>
<span class="sd">            See the documentation of `dpet.visualization.plot_comparison_matrix`</span>
<span class="sd">            for more information about these arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        results: dict</span>
<span class="sd">            A dictionary containing the following keys:</span>
<span class="sd">                `ax`: the Axes object with the comparison matrix heatmap.</span>
<span class="sd">                `scores`: comparison matrix. See `EnsembleAnalysis.comparison_scores`</span>
<span class="sd">                    for more information.</span>
<span class="sd">                `codes`: codes of the ensembles that were compared.</span>
<span class="sd">                `fig`: Figure object, only returned when a new figure is created</span>
<span class="sd">                    inside this function.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        The comparison matrix is annotated with the scores, and the axes are</span>
<span class="sd">        labeled with the ensemble labels.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">### Check input.</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="s2">&quot;ramaJSD&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">exists_coarse_grained</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This analysis is not possible with coarse-grained models.&quot;</span><span class="p">)</span>

        <span class="c1">### Score divergences.</span>
        <span class="n">score_type</span><span class="p">,</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">scores_data</span><span class="p">[</span><span class="n">score</span><span class="p">]</span>

        <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">ensembles</span><span class="p">]</span>
        <span class="n">comparison_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">comparison_scores</span><span class="p">(</span>
            <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
            <span class="n">featurization_params</span><span class="o">=</span><span class="n">featurization_params</span><span class="p">,</span>
            <span class="n">bootstrap_iters</span><span class="o">=</span><span class="n">bootstrap_iters</span><span class="p">,</span>
            <span class="n">bootstrap_frac</span><span class="o">=</span><span class="n">bootstrap_frac</span><span class="p">,</span>
            <span class="n">bootstrap_replace</span><span class="o">=</span><span class="n">bootstrap_replace</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="c1">### Setup the plot.</span>
        <span class="c1"># Axes.</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Title.</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;jsd&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;ca_dist&quot;</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;adaJSD&quot;</span>
                <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;alpha_angle&quot;</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;ataJSD&quot;</span>
                <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;rama&quot;</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;ramaJSD&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> based on </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">score_type</span><span class="p">)</span>
        <span class="c1"># Colorbar label.</span>
        <span class="k">if</span> <span class="n">cbar_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cbar_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> score&quot;</span>

        <span class="c1">### Actually plots.</span>
        <span class="n">plot_comparison_matrix</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">comparison_out</span><span class="o">=</span><span class="n">comparison_out</span><span class="p">,</span>
            <span class="n">codes</span><span class="o">=</span><span class="n">codes</span><span class="p">,</span>
            <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">,</span>
            <span class="n">significance_level</span><span class="o">=</span><span class="n">significance_level</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">cbar_label</span><span class="o">=</span><span class="n">cbar_label</span><span class="p">,</span>
            <span class="n">textcolors</span><span class="o">=</span><span class="n">textcolors</span>
        <span class="p">)</span>

        <span class="c1">### Return results.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ax&quot;</span><span class="p">:</span> <span class="n">ax</span><span class="p">,</span> <span class="s2">&quot;comparison&quot;</span><span class="p">:</span> <span class="n">comparison_out</span><span class="p">,</span> <span class="s2">&quot;codes&quot;</span><span class="p">:</span> <span class="n">codes</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span>
        <span class="k">return</span> <span class="n">results</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Hamidreza Ghafouri, Giacomo Janson, Silvio C.E. Tosatto, Alexander Miguel Monzon.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>